<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üßø Panoramica</title>
	<link rel="icon" type="image/png" href="favicon.png"> 
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
	 <link rel="stylesheet" href="css/menusotto.css">
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="css/trade.css">
 <style>
/* Base styles */
:root {
    --color-primary: #4a90e2;
    --color-secondary: #667eea;
    --color-border: rgba(255,255,255,0.1);
    --color-text: #e0e0e0;
    --color-muted: #a0a0a0;
    --color-surface: rgba(35,35,59,0.6);
    --color-card-bg: rgba(58,58,58,0.15);
    --color-header-bg: rgba(96,96,96,0.3);
}

/* Summary Cards */
.summary-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.card {
    background: linear-gradient(135deg, rgba(58, 58, 58, 0.15) 0%, rgba(96, 96, 96, 0.2) 100%);
    border: 1px solid var(--color-border);
    border-top: 3px solid var(--color-primary);
    border-radius: 8px;
    padding: 25px;
    box-shadow: 0 5px 30px rgba(0,0,0,0.5);
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
    text-align: center;
}

.card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, var(--color-primary), var(--color-secondary));
}

.card:hover {
    box-shadow: 0 8px 40px rgba(74, 144, 226, 0.3);
    transform: translateY(-5px);
}

.card h3 {
    color: #F2BB66;
    margin-bottom: 14px;
    font-size: 1.3em;
    font-weight: 500;
    opacity: 0.95;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.card .value {
    font-size: 32px;
    font-weight: 700;
    color: var(--color-text);
    margin-bottom: 8px;
    line-height: 1.2;
}

.card .subvalue {
    font-size: 14px;
    color: var(--color-muted);
    font-weight: 500;
}

/* Sections */
.section {
    background: linear-gradient(135deg, rgba(58, 58, 58, 0.15) 0%, rgba(96, 96, 96, 0.2) 100%);
    border: 1px solid var(--color-border);
    border-top: 3px solid var(--color-primary);
    border-radius: 8px;
    padding: 25px;
    margin-bottom: 20px;
    box-shadow: 0 5px 30px rgba(0,0,0,0.5);
}

.section h2 {
    color: #F2BB66;
    margin-bottom: 20px;
    font-size: 1.4em;
    font-weight: 500;
    border-bottom: 2px solid var(--color-border);
    padding-bottom: 10px;
}

.tax-section {
    border-top-color: #764ba2;
}

.tax-section h2 {
    color: #764ba2;
}

#taxInfo {
    background: linear-gradient(135deg, rgba(58, 58, 58, 0.15) 0%, rgba(96, 96, 96, 0.2) 100%);
    border: 1px solid var(--color-border);
    border-top: 3px solid #764ba2;
    border-radius: 8px;
    padding: 25px;
    margin-top: 20px;
    box-shadow: 0 5px 30px rgba(0,0,0,0.5);
}

#taxInfo h3 {
    color: #764ba2;
    margin-bottom: 20px;
    font-size: 1.2em;
    font-weight: 500;
    border-bottom: 2px solid var(--color-border);
    padding-bottom: 10px;
}

#taxInfo div {
    padding: 12px;
    background: rgba(35, 35, 59, 0.4);
    border-radius: 6px;
    border-left: 3px solid var(--color-primary);
}

/* Input Groups */
.input-group {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    margin-bottom: 20px;
}

.input-field {
    flex: 1;
    min-width: 200px;
}

.input-field label {
    display: block;
    color: #F2BB66;
    margin-bottom: 8px;
    font-weight: 500;
    font-size: 0.95em;
}

.input-field input,
.input-field select {
    width: 100%;
    padding: 12px 15px;
    border: 1px solid var(--color-border);
    border-radius: 6px;
    background: rgba(35, 35, 59, 0.4);
    color: var(--color-text);
    font-size: 1em;
    transition: all 0.3s ease;
}

.input-field input:focus,
.input-field select:focus {
    outline: none;
    border-color: var(--color-primary);
    box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.2);
    background: rgba(35, 35, 59, 0.6);
}

/* Buttons */
button {
    background: linear-gradient(135deg, var(--color-primary), var(--color-secondary));
    border: none;
    border-radius: 8px;
    padding: 15px 25px;
    color: white;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 20px rgba(74, 144, 226, 0.4);
    margin-right: 10px;
}

button:hover {
    background: linear-gradient(135deg, var(--color-secondary), var(--color-primary));
    box-shadow: 0 6px 30px rgba(74, 144, 226, 0.6);
    transform: translateY(-2px);
}

.refresh-btn {
    background: linear-gradient(135deg, #2ecc71, #27ae60);
}

.refresh-btn:hover {
    background: linear-gradient(135deg, #27ae60, #229954);
    box-shadow: 0 6px 25px rgba(46, 204, 113, 0.6);
}

.delete-btn {
    background: linear-gradient(135deg, #ff4757, #ff3838);
    padding: 8px 18px;
    font-size: 14px;
}

.delete-btn:hover {
    background: linear-gradient(135deg, #ff3838, #ff1f1f);
    box-shadow: 0 4px 20px rgba(255,71,87,0.5);
}

/* Lists */
.deposits-list, .staking-list {
    margin-top: 20px;
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.deposit-item, .staking-item {
    background: linear-gradient(135deg, rgba(58, 58, 58, 0.15) 0%, rgba(96, 96, 96, 0.2) 100%);
    border: 1px solid var(--color-border);
    border-top: 3px solid var(--color-primary);
    border-radius: 8px;
    padding: 25px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 5px 30px rgba(0,0,0,0.5);
    transition: all 0.3s ease;
}

.deposit-item:hover, .staking-item:hover {
    box-shadow: 0 8px 40px rgba(74, 144, 226, 0.2);
    transform: translateX(2px);
}

/* Tax Info */
#taxInfo {
    background: linear-gradient(135deg, rgba(58, 58, 58, 0.15) 0%, rgba(96, 96, 96, 0.2) 100%);
    border: 1px solid var(--color-border);
    border-top: 3px solid #764ba2;
    border-radius: 8px;
    padding: 25px;
    margin-top: 20px;
    box-shadow: 0 5px 30px rgba(0,0,0,0.5);
}

#taxInfo h3 {
    color: #764ba2;
    margin-bottom: 20px;
    font-size: 1.2em;
    font-weight: 500;
    border-bottom: 2px solid var(--color-border);
    padding-bottom: 10px;
}

#taxInfo > div {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 10px;
    margin-top: 15px;
}

#taxInfo > div > div {
    padding: 12px;
    background: rgba(35, 35, 59, 0.4);
    border-radius: 6px;
    border-left: 3px solid var(--color-primary);
}

/* Chart */
.chart-container {
    background: linear-gradient(135deg, rgba(58, 58, 58, 0.15) 0%, rgba(96, 96, 96, 0.2) 100%);
    border: 1px solid var(--color-border);
    border-top: 3px solid var(--color-primary);
    border-radius: 8px;
    padding: 25px;
    height: 400px;
    position: relative;
    margin-top: 20px;
}

/* Utilities */
.profit-positive {
    color: #2ecc71 !important;
    font-weight: bold;
}

.profit-negative {
    color: #e74c3c !important;
    font-weight: bold;
}

.warning-box {
    background: linear-gradient(135deg, rgba(58, 58, 58, 0.15) 0%, rgba(96, 96, 96, 0.2) 100%);
    border: 1px solid var(--color-border);
    border-top: 3px solid #ffc107;
    border-radius: 8px;
    padding: 25px;
    margin-bottom: 20px;
    box-shadow: 0 5px 30px rgba(0,0,0,0.5);
}

.warning-box p {
    color: var(--color-text);
    margin: 10px 0;
}

.loading {
    text-align: center;
    color: var(--color-primary);
    font-size: 18px;
    padding: 40px;
    background: linear-gradient(135deg, rgba(58, 58, 58, 0.15) 0%, rgba(96, 96, 96, 0.2) 100%);
    border-radius: 8px;
    border-top: 3px solid var(--color-primary);
}
</style>

</head>
<body>
<div style="padding: 4px;"></div>
<div class="container">
<!-- Titolo a sinistra, sottotitolo a destra -->

<div class="container-f" style="display:flex; align-items:center; justify-content:space-between; padding:4px 0;">
  <h1 style="margin:0; font-size:1.75rem; line-height:1.8;">üßø Panoramica</h1>

 <div >
            <p><strong>*Dati di backup:</strong> ultimo agg:</strong> <span id="lastUpdate">-</span></p>
			<p><strong>üíπ Prezzo ATOM:</strong> <span id="atomPrice">Caricamento...</span></p>
        </div>
</div>

</div>
<div style="padding: 4px;"></div> 
<div class="container">

 <div class="container" style="padding-top: 12px; padding-bottom: 12px;">
 <!-- BLOCCO MENU -->
  <div class="iflow-body">
    <nav class="iflow-custom-menu">
      <ul>
        <li>
          <div class="iflow-menu-label">Trade</div>
          <ul>
            <li><a href="https://beneinst.github.io/tradingspot/">Trade attivi</a></li>
			<li><a href="https://beneinst.github.io/tradingspot/operativita.html">Operativit√†</a></li>
			<li><a href="https://beneinst.github.io/tradingspot/analisi.html">Analisi</a></li>
          </ul>
        </li>
		 
        <li>
          <div class="iflow-menu-label">Capitale</div>
          <ul>
           
			<li><a href="https://beneinst.github.io/tradingspot/flowchart.html">Panoramica</a></li>
			<li><a href="https://beneinst.github.io/tradingspot/fiscoit.html">Fisco</a></li>
			<li><a href="https://beneinst.github.io/tradingspot/staking.html">Figment</a></li>
			<li><a href="https://beneinst.github.io/tradingspot/staking2.html">Ledger</a></li>
			
          </ul>
        </li>
       
        <li>
          <div class="iflow-menu-label">Strategia</div>
          <ul>
		  <li><a href="https://beneinst.github.io/tradingspot/blocco-note.html">Blocco Note</a></li>
		  <li><a href="https://beneinst.github.io/tradingspot/regole-trading.html">Regole</a></li>
            <li><a href="https://beneinst.github.io/tradingspot/Strategia-Trading.html">Indicatore 4H</a></li>
           
          </ul>
        </li>
       
		<li>
          <div class="iflow-menu-label">Backup</div>
          <ul>
            <li><a href="https://beneinst.github.io/tradingspot/backup.html">Backup</a></li>
          </ul>
        </li>
		
      </ul>
    </nav>
  </div>
  </div>       
 <div style="padding: 6px;"></div> 
   
     
         <div class="summary-cards">
            <div class="card">
                <h3>Totale Depositato</h3>
                <div class="value" id="totalDeposits">$0.00</div>
            </div>
            <div class="card">
                <h3>Profitto Trading</h3>
                <div class="value" id="tradingProfit">$0.00</div>
                <div class="subvalue" id="tradingCount">0 operazioni</div>
            </div>
            <div class="card">
                <h3>Valore Staking</h3>
                <div class="value" id="stakingValue">$0.00</div>
                <div class="subvalue" id="stakingAmount">0 ATOM</div>
            </div>
            <div class="card">
                <h3>Totale Patrimonio</h3>
                <div class="value" id="totalEquity">$0.00</div>
            </div>
        </div>
        
        <div class="section">
            <h2>üí∞ Aggiungi Deposito</h2>
            <div class="input-group">
                <div class="input-field">
                    <label>Data</label>
                    <input type="date" id="depositDate">
                </div>
                <div class="input-field">
                    <label>Importo ($)</label>
                    <input type="number" id="depositAmount" step="0.01" placeholder="1000.00">
                </div>
                <div class="input-field">
                    <label>Valuta</label>
                    <select id="depositCurrency">
                        <option value="USD">USD</option>
                        <option value="EUR">EUR</option>
                    </select>
                </div>
                <div class="input-field">
                    <label>Note</label>
                    <input type="text" id="depositNote" placeholder="Deposito iniziale">
                </div>
            </div>
            <button onclick="addDeposit()">Aggiungi Deposito</button>
            <button class="refresh-btn" onclick="loadAllData()">üîÑ Ricarica Dati</button>
            
            <div class="deposits-list" id="depositsList"></div>
        </div>
        
        <div class="section tax-section">
            <h2>ü™ô ATOM Non Depositati (Staking Rewards)</h2>
            <p style="margin-bottom: 15px; color: #555;">Inserisci la quantit√† di ATOM ricevuti dallo staking che non sono stati registrati come deposito in USDC. Questo valore serve per calcolare le plusvalenze fiscali.</p>
            
            <div class="input-group">
                <div class="input-field">
                    <label>ATOM da Staking (non depositati)</label>
                    <input type="number" id="unrecordedAtom" step="0.000001" placeholder="0.000000">
                </div>
                <div class="input-field">
                    <label>Prezzo Medio di Acquisizione ($)</label>
                    <input type="number" id="atomAvgPrice" step="0.0001" placeholder="0.0000">
                </div>
            </div>
            <button onclick="saveUnrecordedAtom()">üíæ Salva ATOM Non Depositati</button>
            
            <div id="taxInfo" style="margin-top: 20px; padding: 15px; background: white; border-radius: 8px;">
                <h3 style="color: #764ba2; margin-bottom: 10px;">üìä Calcolo Plusvalenza Fiscale</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                    <div><strong>ATOM Non Depositati:</strong> <span id="taxAtomAmount">0.000000</span></div>
                    <div><strong>Costo Medio:</strong> $<span id="taxCostBasis">0.00</span></div>
                    <div><strong>Valore Attuale:</strong> $<span id="taxCurrentValue">0.00</span></div>
                    <div class="profit-positive"><strong>Plusvalenza:</strong> $<span id="taxCapitalGain">0.00</span></div>
                </div>
            </div>
        </div>
        
        <div class="section">
            <h2>ü™ô Gestione Staking</h2>
            <div class="staking-list" id="stakingList"></div>
        </div>
        
        <div class="section">
            <h2>üìà Grafico Patrimonio</h2>
            <div class="chart-container">
                <canvas id="equityChart"></canvas>
            </div>
        </div>
    </div>
	
	<div style="padding: 1px;"></div> 

  	
        
   <!-- FOOTER -->

<div style="padding: 5px;"></div>  

<div class="container">
  <div class="container-f" style="padding-top: 1px; padding-bottom: 1px;">
    <div style="display: flex; align-items: center; justify-content: space-between;">
     <img src="images/logoinvest2a3.svg"
           alt="FlowChart"
           style="height: 50px; width: auto; margin-right: 16px;" />
		   <p style="margin: 0; color: #c3c3c3; text-align: left; height: 10px; line-height: 12px;">
        ¬© 2025 FlowChart by Gerardo D'Orrico. Tutti i diritti riservati.
      </p>
    </div></div>
</div>
    
 <!-- Bottone torna sopra principale (con freccia CSS) -->
    <button class="back-to-top" id="backToTop" title="Torna in cima"></button>  
    
     <script>
        let deposits = [];
        let tradingData = null;
        let stakingData = {};
        let chart = null;
        let atomPrice = 0;
        let unrecordedAtomData = { amount: 0, avgPrice: 0 };
        
        // Cache per prezzi Binance
        const priceCache = {};
        const CACHE_DURATION = 60000; // 1 minuto
        
        // ------------------------------------------------------------------
        //  Prezzi da Binance
        // ------------------------------------------------------------------
        async function getPriceFromBinance(symbol) {
            const cleanSymbol = symbol.toUpperCase();
            const now = Date.now();
            
            const pairUSDT = `${cleanSymbol}USDT`;
            const pairUSDC = `${cleanSymbol}USDC`;
            
            const cacheKey = cleanSymbol.toLowerCase();
            if (priceCache[cacheKey] && (now - priceCache[cacheKey].timestamp) < CACHE_DURATION) {
                return priceCache[cacheKey].price;
            }
            
            try {
                let response = await fetch(`https://api.binance.com/api/v3/ticker/price?symbol=${pairUSDT}`);
                
                if (!response.ok) {
                    response = await fetch(`https://api.binance.com/api/v3/ticker/price?symbol=${pairUSDC}`);
                }
                
                if (!response.ok) throw new Error(`Coppia non trovata su Binance per ${cleanSymbol}`);
                
                const data = await response.json();
                const price = parseFloat(data.price);
                
                priceCache[cacheKey] = { price, timestamp: now };
                return price;
            } catch (error) {
                console.warn(`Binance: Prezzo non trovato per ${cleanSymbol}`, error);
                return null;
            }
        }
        
        // Carica prezzo ATOM
        async function loadAtomPrice() {
            try {
                const price = await getPriceFromBinance('ATOM');
                if (price) {
                    atomPrice = price;
                    document.getElementById('atomPrice').textContent = `$${price.toFixed(4)} (Binance)`;
                    updateAllPrices();
                } else {
                    document.getElementById('atomPrice').textContent = 'Non disponibile';
                }
            } catch (error) {
                console.error('Errore caricamento prezzo ATOM:', error);
                document.getElementById('atomPrice').textContent = 'Errore';
            }
        }
        
        // Aggiorna tutti i prezzi
        function updateAllPrices() {
            // Aggiorna prezzi nei portfolio staking
            if (stakingData.atomPortfolio_1) {
                stakingData.atomPortfolio_1.currentPrice = atomPrice;
            }
            if (stakingData.atomPortfolio) {
                stakingData.atomPortfolio.currentPrice = atomPrice;
            }
            
            renderStakingList();
            updateSummary();
            updateTaxInfo();
            updateChart();
        }
        
        // Carica tutti i dati dal localStorage
        function loadAllData() {
            console.log('üîÑ Caricamento dati dal localStorage...');
            
            // Carica depositi
            const savedDeposits = localStorage.getItem('portfolioDeposits');
            if (savedDeposits) {
                try {
                    deposits = JSON.parse(savedDeposits);
                    console.log('‚úÖ Depositi caricati:', deposits.length);
                } catch (e) {
                    console.error('‚ùå Errore caricamento depositi:', e);
                    deposits = [];
                }
            }
            
            // Carica ATOM non depositati
            const savedUnrecorded = localStorage.getItem('unrecordedAtomData');
            if (savedUnrecorded) {
                try {
                    unrecordedAtomData = JSON.parse(savedUnrecorded);
                    document.getElementById('unrecordedAtom').value = unrecordedAtomData.amount;
                    document.getElementById('atomAvgPrice').value = unrecordedAtomData.avgPrice;
                    console.log('‚úÖ ATOM non depositati caricati:', unrecordedAtomData);
                } catch (e) {
                    console.error('‚ùå Errore caricamento ATOM non depositati:', e);
                }
            }
            
            // Carica dati trading
            loadTradingData();
            
            // Carica dati staking
            loadStakingData();
            
            // Aggiorna interfaccia
            renderDeposits();
            renderStakingList();
            updateSummary();
            updateTaxInfo();
            updateChart();
            updateLastUpdate();
            
            // Carica prezzo ATOM
            loadAtomPrice();
        }
        
        // Carica dati trading
        function loadTradingData() {
            tradingData = { closedTrades: [], datiCapitale: {}, singleTrades: [] };
            
            // Prova a caricare closedTrades
            const closedTradesStr = localStorage.getItem('closedTrades');
            if (closedTradesStr) {
                try {
                    const parsed = JSON.parse(closedTradesStr);
                    tradingData.closedTrades = Array.isArray(parsed) ? parsed : [];
                    console.log('‚úÖ closedTrades caricati:', tradingData.closedTrades.length);
                } catch (e) {
                    console.warn('‚ö†Ô∏è Errore parsing closedTrades:', e);
                }
            }
            
            // Prova a caricare datiCapitale
            const datiCapitaleStr = localStorage.getItem('datiCapitale');
            if (datiCapitaleStr) {
                try {
                    tradingData.datiCapitale = JSON.parse(datiCapitaleStr) || {};
                    console.log('‚úÖ datiCapitale caricati');
                } catch (e) {
                    console.warn('‚ö†Ô∏è Errore parsing datiCapitale:', e);
                }
            }
            
            // Prova a caricare singleTrades
            const singleTradesStr = localStorage.getItem('singleTrades');
            if (singleTradesStr) {
                try {
                    const parsed = JSON.parse(singleTradesStr);
                    tradingData.singleTrades = Array.isArray(parsed) ? parsed : [];
                    console.log('‚úÖ singleTrades caricati:', tradingData.singleTrades.length);
                } catch (e) {
                    console.warn('‚ö†Ô∏è Errore parsing singleTrades:', e);
                }
            }
        }
        
        // Carica dati staking
        function loadStakingData() {
            stakingData = {};
            
            // atomPortfolio_1
            const ap1Str = localStorage.getItem('atomPortfolio_1');
            if (ap1Str) {
                try {
                    stakingData.atomPortfolio_1 = JSON.parse(ap1Str);
                    console.log('‚úÖ atomPortfolio_1 caricato');
                } catch (e) {
                    console.warn('‚ö†Ô∏è Errore parsing atomPortfolio_1:', e);
                }
            }
            
            // atomPortfolio
            const apStr = localStorage.getItem('atomPortfolio');
            if (apStr) {
                try {
                    stakingData.atomPortfolio = JSON.parse(apStr);
                    console.log('‚úÖ atomPortfolio caricato');
                } catch (e) {
                    console.warn('‚ö†Ô∏è Errore parsing atomPortfolio:', e);
                }
            }
            
            // currentMonthEntries
            const cmeStr = localStorage.getItem('currentMonthEntries');
            if (cmeStr) {
                try {
                    stakingData.currentMonthEntries = JSON.parse(cmeStr);
                    console.log('‚úÖ currentMonthEntries caricati');
                } catch (e) {
                    console.warn('‚ö†Ô∏è Errore parsing currentMonthEntries:', e);
                }
            }
            
            // historicalEntries
            const heStr = localStorage.getItem('historicalEntries');
            if (heStr) {
                try {
                    stakingData.historicalEntries = JSON.parse(heStr);
                    console.log('‚úÖ historicalEntries caricati');
                } catch (e) {
                    console.warn('‚ö†Ô∏è Errore parsing historicalEntries:', e);
                }
            }
        }
        
        // Salva depositi
        function saveDeposits() {
            localStorage.setItem('portfolioDeposits', JSON.stringify(deposits));
            updateLastUpdate();
        }
        
        // Salva ATOM non depositati
        function saveUnrecordedAtom() {
            const amount = parseFloat(document.getElementById('unrecordedAtom').value) || 0;
            const avgPrice = parseFloat(document.getElementById('atomAvgPrice').value) || 0;
            
            unrecordedAtomData = { amount, avgPrice };
            localStorage.setItem('unrecordedAtomData', JSON.stringify(unrecordedAtomData));
            
            updateTaxInfo();
            updateSummary();
            updateChart();
            
            alert('‚úÖ ATOM non depositati salvati con successo!');
        }
        
        // Aggiorna info fiscali
        function updateTaxInfo() {
            const amount = unrecordedAtomData.amount || 0;
            const avgPrice = unrecordedAtomData.avgPrice || 0;
            const costBasis = amount * avgPrice;
            const currentValue = amount * atomPrice;
            const capitalGain = currentValue - costBasis;
            
            document.getElementById('taxAtomAmount').textContent = amount.toFixed(6);
            document.getElementById('taxCostBasis').textContent = costBasis.toFixed(2);
            document.getElementById('taxCurrentValue').textContent = currentValue.toFixed(2);
            document.getElementById('taxCapitalGain').textContent = capitalGain.toFixed(2);
            
            // Colora in base al guadagno/perdita
            const gainElement = document.getElementById('taxCapitalGain').parentElement;
            if (capitalGain >= 0) {
                gainElement.className = 'profit-positive';
            } else {
                gainElement.className = 'profit-negative';
            }
        }
        
        // Salva dati staking aggiornati
        function saveStakingData() {
            if (stakingData.atomPortfolio_1) {
                localStorage.setItem('atomPortfolio_1', JSON.stringify(stakingData.atomPortfolio_1));
            }
            if (stakingData.atomPortfolio) {
                localStorage.setItem('atomPortfolio', JSON.stringify(stakingData.atomPortfolio));
            }
            updateLastUpdate();
        }
        
        // Aggiorna timestamp ultimo aggiornamento
        function updateLastUpdate() {
            const now = new Date();
            document.getElementById('lastUpdate').textContent = now.toLocaleString('it-IT');
        }
        
        // Aggiungi deposito
        function addDeposit() {
            const date = document.getElementById('depositDate').value;
            const amount = parseFloat(document.getElementById('depositAmount').value);
            const currency = document.getElementById('depositCurrency').value;
            const note = document.getElementById('depositNote').value;
            
            if (!date || !amount || isNaN(amount)) {
                alert('‚ö†Ô∏è Inserisci data e importo validi');
                return;
            }
            
            deposits.push({
                id: Date.now(),
                date: date,
                amount: amount,
                currency: currency,
                note: note
            });
            
            deposits.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            saveDeposits();
            renderDeposits();
            updateSummary();
            updateChart();
            
            document.getElementById('depositAmount').value = '';
            document.getElementById('depositNote').value = '';
            
            alert('‚úÖ Deposito aggiunto con successo!');
        }
        
        // Rimuovi deposito
        function removeDeposit(id) {
            if (!confirm('‚ö†Ô∏è Sei sicuro di voler eliminare questo deposito?')) return;
            
            deposits = deposits.filter(d => d.id !== id);
            saveDeposits();
            renderDeposits();
            updateSummary();
            updateChart();
        }
        
        // Renderizza lista depositi
        function renderDeposits() {
            const list = document.getElementById('depositsList');
            if (deposits.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: #999; margin-top: 20px;">Nessun deposito inserito</p>';
                return;
            }
            
            list.innerHTML = deposits.map(d => `
                <div class="deposit-item">
                    <div>
                        <strong>${new Date(d.date).toLocaleDateString('it-IT')}</strong> - 
                        ${d.amount.toFixed(2)} ${d.currency}
                        ${d.note ? '<br><small style="color: #666;">' + d.note + '</small>' : ''}
                    </div>
                    <button class="delete-btn" onclick="removeDeposit(${d.id})">üóëÔ∏è Elimina</button>
                </div>
            `).join('');
        }
        
        // Calcola profitto trading
        function calculateTradingProfit() {
            if (!tradingData || !Array.isArray(tradingData.closedTrades)) return 0;
            
            return tradingData.closedTrades.reduce((sum, trade) => {
                const profit = parseFloat(trade.profit) || 0;
                return sum + profit;
            }, 0);
        }
        
        // Calcola valore staking totale
        function calculateStakingValue() {
            let total = 0;
            
            if (stakingData.atomPortfolio_1) {
                const holdings = parseFloat(stakingData.atomPortfolio_1.currentHoldings) || 0;
                total += holdings * atomPrice;
            }
            
            if (stakingData.atomPortfolio) {
                const holdings = parseFloat(stakingData.atomPortfolio.currentHoldings) || 0;
                total += holdings * atomPrice;
            }
            
            // Aggiungi valore ATOM non depositati
            total += (unrecordedAtomData.amount || 0) * atomPrice;
            
            return total;
        }
        
        // Calcola totale ATOM
        function calculateTotalAtom() {
            let total = 0;
            
            if (stakingData.atomPortfolio_1) {
                total += parseFloat(stakingData.atomPortfolio_1.currentHoldings) || 0;
            }
            
            if (stakingData.atomPortfolio) {
                total += parseFloat(stakingData.atomPortfolio.currentHoldings) || 0;
            }
            
            total += unrecordedAtomData.amount || 0;
            
            return total;
        }
        
        // Renderizza lista staking
        function renderStakingList() {
            const list = document.getElementById('stakingList');
            let html = '';
            
            if (stakingData.atomPortfolio_1) {
                html += renderStakingItem('ATOM Portfolio 1', stakingData.atomPortfolio_1, 'atomPortfolio_1');
            }
            
            if (stakingData.atomPortfolio) {
                html += renderStakingItem('ATOM Portfolio', stakingData.atomPortfolio, 'atomPortfolio');
            }
            
            if (!html) {
                html = '<p style="text-align: center; color: #999;">Nessun dato di staking disponibile</p>';
            }
            
            list.innerHTML = html;
        }
        
        // Renderizza singolo item staking
        function renderStakingItem(name, portfolio, key) {
            const invested = parseFloat(portfolio.totalInvested) || 0;
            const holdings = parseFloat(portfolio.currentHoldings) || 0;
            const avgPrice = parseFloat(portfolio.averagePrice) || 0;
            const currentValue = holdings * atomPrice;
            const profit = currentValue - invested;
            const profitPercent = invested > 0 ? (profit / invested * 100) : 0;
            
            return `
                <div class="staking-item">
                    <div style="width: 100%;">
                        <h3 style="margin-bottom: 10px; color: #667eea;">${name}</h3>
                        <div class="staking-info">
                            <div><strong>üí∞ Investito USDC:</strong> $${invested.toFixed(2)}</div>
                            <div><strong>ü™ô Detenuto ATOM:</strong> ${holdings.toFixed(6)}</div>
                            <div><strong>üìä Prezzo Medio:</strong> $${avgPrice.toFixed(4)}</div>
                            <div><strong>üíπ Prezzo Attuale:</strong> $${atomPrice.toFixed(4)}</div>
                            <div><strong>üíµ Valore Attuale:</strong> $${currentValue.toFixed(2)}</div>
                            <div class="${profit >= 0 ? 'profit-positive' : 'profit-negative'}">
                                <strong>üìà P/L:</strong> ${profit.toFixed(2)} (${profitPercent.toFixed(2)}%)
                            </div>
                        </div>
                        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #ddd;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Aggiorna Holdings:</label>
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <input type="number" id="${key}_holdings" step="0.000001" 
                                       placeholder="Nuovi ATOM totali" style="flex: 1; min-width: 150px;">
                                <button onclick="updateStaking('${key}')">‚úÖ Aggiorna</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Aggiorna staking
        function updateStaking(key) {
            const newHoldings = parseFloat(document.getElementById(key + '_holdings').value);
            
            if (!stakingData[key]) {
                alert('‚ùå Portfolio non trovato');
                return;
            }
            
            if (isNaN(newHoldings) || newHoldings <= 0) {
                alert('‚ö†Ô∏è Inserisci una quantit√† valida di ATOM');
                return;
            }
            
            stakingData[key].currentHoldings = newHoldings;
            
            saveStakingData();
            renderStakingList();
            updateSummary();
            updateChart();
            
            document.getElementById(key + '_holdings').value = '';
            
            alert('‚úÖ Staking aggiornato con successo!');
        }
        
        // Aggiorna riepilogo
        function updateSummary() {
            const totalDeposits = deposits.reduce((sum, d) => sum + d.amount, 0);
            const tradingProfit = calculateTradingProfit();
            const stakingValue = calculateStakingValue();
            const totalEquity = totalDeposits + tradingProfit + stakingValue;
            const totalAtom = calculateTotalAtom();
            
            document.getElementById('totalDeposits').textContent = ' + totalDeposits.toFixed(2);
            document.getElementById('tradingProfit').textContent = ' + tradingProfit.toFixed(2);
            document.getElementById('tradingCount').textContent = (tradingData?.closedTrades?.length || 0) + ' operazioni';
            document.getElementById('stakingValue').textContent = ' + stakingValue.toFixed(2);
            document.getElementById('stakingAmount').textContent = totalAtom.toFixed(6) + ' ATOM';
            document.getElementById('totalEquity').textContent = ' + totalEquity.toFixed(2);
        }
        
        // Aggiorna grafico
        function updateChart() {
            const ctx = document.getElementById('equityChart').getContext('2d');
            
            if (chart) {
                chart.destroy();
            }
            
            const dataPoints = [];
            let cumulativeDeposits = 0;
            const tradingProfit = calculateTradingProfit();
            const stakingValue = calculateStakingValue();
            
            deposits.forEach(d => {
                cumulativeDeposits += d.amount;
                dataPoints.push({
                    date: new Date(d.date),
                    deposits: cumulativeDeposits,
                    equity: cumulativeDeposits + tradingProfit + stakingValue
                });
            });
            
            if (dataPoints.length > 0 || tradingData || Object.keys(stakingData).length > 0) {
                dataPoints.push({
                    date: new Date(),
                    deposits: cumulativeDeposits,
                    equity: cumulativeDeposits + tradingProfit + stakingValue
                });
            }
            
            if (dataPoints.length === 0) {
                dataPoints.push(
                    { date: new Date(Date.now() - 30*24*60*60*1000), deposits: 0, equity: 0 },
                    { date: new Date(), deposits: 0, equity: 0 }
                );
            }
            
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dataPoints.map(p => p.date.toLocaleDateString('it-IT')),
                    datasets: [
                        {
                            label: 'Depositi Cumulativi',
                            data: dataPoints.map(p => p.deposits),
                            borderColor: '#764ba2',
                            backgroundColor: 'rgba(118, 75, 162, 0.1)',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'Patrimonio Totale',
                            data: dataPoints.map(p => p.equity),
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            tension: 0.4,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                font: { size: 14 },
                                padding: 15
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ':  + context.parsed.y.toFixed(2);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return ' + value.toFixed(0);
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Funzioni per bottone torna sopra
        function toggleBackToTopButton() {
            const backToTop = document.getElementById('backToTop');
            if (window.pageYOffset > 300) {
                backToTop.classList.add('show');
            } else {
                backToTop.classList.remove('show');
            }
        }
        
        function scrollToTop() {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }
        
        // Event listeners
        window.addEventListener('scroll', toggleBackToTopButton);
        document.getElementById('backToTop').addEventListener('click', scrollToTop);
        
        // Imposta data corrente
        document.getElementById('depositDate').valueAsDate = new Date();
        
        // Carica tutti i dati all'avvio
        loadAllData();
        toggleBackToTopButton();
        
        // Aggiorna prezzo ATOM ogni 5 minuti
        setInterval(loadAtomPrice, 5 * 60 * 1000);
        
        console.log('‚úÖ Crypto Portfolio Tracker caricato completamente');
    </script>
</body>
</html>