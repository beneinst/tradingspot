<!DOCTYPE html>
<html lang="it">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panoramica Capitale Trading</title>
  <link rel="icon" type="image/png" href="favicon.png"> 
  <style>
 :root {
  --primary-color: #739bf2;       /* Blu-grigio elegante */
  --secondary-color: #393e46;     /* Grigio scuro */
  --accent-color: #f44336;        /* Rosso */
  --background-color: #232526;    /* Sfondo principale */
  --card-color: #2c2c2c;          /* Sfondo card */
  --border-color: #393e46;        /* Bordo elementi/tabella */
  --text-color: #e0e0e0;          /* Testo principale chiaro */
  --text-light: #bfc9d1;          /* Testo secondario */
  --highlight-light: #ffe58f;     /* Evidenziato corrente */
  --highlight-green: #c7ffc7;     /* Evidenziato verde */
  --highlight-red: #ffc7c7;       /* Evidenziato rosso */
  --header-bg: #333a56;           /* Sfondo header */
  --hover-link: #ffdb58;          /* Hover link footer */
}



  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }

 body {
  background: linear-gradient(135deg, var(--background-color) 0%, #2a2a2a 100%);
  font-family: 'Poppins', sans-serif;
  color: var(--text-color);
  line-height: 1.6;
  padding: 20px;
}


  .container {
    max-width: 1300px;
    margin: 0 auto;
  }

  .header,
  .head2 {
     background-color: #222831;
    padding: 20px 25px;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.7);
    margin-bottom: 20px;
    width: 100%;
    box-sizing: border-box;
  }

  h1 {
    color: var(--primary-color);
    font-size: 28px;
    margin-bottom: 10px;
  }

  .header-stats {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin-bottom: 20px;
    flex-wrap: wrap;
  }

  .header-stat-item {
  padding: 10px 20px;
  text-align: center;
  min-width: 140px;
  background-color: #222831;
  border-radius: 10px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.7);
  margin-bottom: 20px;
  box-sizing: border-box;
  transition: background 0.3s, box-shadow 0.3s;
}

.header-stat-item:hover {
  background: linear-gradient(120deg, #393e46 60%, #232a34 100%);
  box-shadow: 0 4px 20px rgba(57, 62, 70, 0.5);
  color: #ffe58f !important; /* Testo evidenziato chiaro */
  cursor: pointer;
}



  .header-stat-label {
    font-size: 14px;
    color: var(--text-light);
    margin-bottom: 2px;
  }

  .header-stat-value {
    font-size: 20px;
    font-weight: bold;
  }

  .quota-input {
    width: 70px;
    padding: 5px;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    text-align: center;
    font-size: 16px;
    font-weight: bold;
  }

  .info-box {
    background-color: rgba(52, 152, 219, 0.2);
    border-left: 4px solid var(--primary-color);
    padding: 15px 15px;
    border-radius: 4px;
    margin-bottom: 20px;
	text-align: justify;
	color: #CFECEC;
    font-size: 15px;
  }

  .card {
    background-color: var(--card-color);
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      padding: 20px;
      margin-bottom: 20px;
	
  }

  .card-header {
   background-color: #222831;
    padding: 20px 25px;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.7);
    margin-bottom: 20px;
    width: 100%;
    box-sizing: border-box;
    }


  .titolo-bianco {
    color: #ffffff;
    font-size: 28px;
    margin: 0;
    line-height: 28px;
  }

  .card h2 {
    color: var(--primary-color);
    font-size: 18px;
  }

  .stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 20px;
  margin-bottom: 30px;
  padding: 20px;
  background: linear-gradient(135deg, #232526 0%, #393e46 100%);
  border-radius: 16px;
  box-shadow: 0 4px 24px rgba(0,0,0,0.4);
}

.stat-item {
  background: linear-gradient(120deg, #222831 60%, #393e46 100%);
  padding: 28px 32px;
  border-radius: 12px;
  box-shadow: 0 2px 14px rgba(0,0,0,0.7);
  width: 100%;
  box-sizing: border-box;
  color: #f6f7fb;
  border: 1.5px solid #393e46;
  position: relative;
  transition: 
    background 0.3s,
    box-shadow 0.3s,
    transform 0.2s,
    border-color 0.3s;
}

.stat-item:hover {
  background: linear-gradient(120deg, var(--primary-color, #0099ff) 60%, #00c6ff 100%);
  color: #fff;
  border-color: var(--primary-color, #0099ff);
  box-shadow: 0 8px 32px rgba(0,153,255,0.25);
  transform: translateY(-6px) scale(1.03);
  z-index: 2;
  cursor: pointer;
}

.stat-label {
  font-size: 16px;
  color: var(--text-light, #bfc9d1);
  margin-bottom: 8px;
  letter-spacing: 0.5px;
  font-weight: 500;
  text-transform: uppercase;
}

.stat-value {
  font-size: 34px;
  font-weight: bold;
  color: #fff;
  letter-spacing: 1px;
  text-shadow: 0 2px 10px rgba(0,153,255,0.15);
}

  .coingecko {
    color: #C85A17;
  }

  .binance {
    color: #FBB917;
  }

  .totale {
    color: #F62817;
  }

  .capitale {
    color: #1AA6ED;
  }


  label {
    display: block;
    margin-bottom: 5px;
    font-weight: 500;
  }

 :root {
  --border-color: #6c63ff;
  --input-bg: #e3e4fa;
  --input-focus-bg: #f5f6ff;
  --input-focus-border: #4f8cff;
  --input-shadow: 0 4px 16px rgba(76, 81, 255, 0.08);
}

.form-group {
  margin-bottom: 18px;
  width: 100%;
  max-width: 320px;
  padding: 12px 16px;
  background-color: #2c2c2c;
  border-radius: 12px;
  border: 2px solid #232a34; /* Bordo visibile */
  box-shadow: 0 2px 8px rgba(0,0,0,0.5);
  transition: 
    background-color 0.3s,
    box-shadow 0.3s,
    border-color 0.3s;
}

.form-group:focus-within {
  background-color: #393e46;
  border-color: var(--primary-color, #0099ff);
  box-shadow: 0 4px 16px rgba(0,153,255,0.3);
}


.input-group {
  display: flex;
  align-items: center;
  gap: 8px; /* Spazio tra input e eventuali bottoni */
  width: 100%;
  max-width: 350px; /* Limita la larghezza anche per il gruppo */
}

.input-group input,
input {
  width: 100%;
  min-width: 120px;
  max-width: 350px;
  padding: 12px 16px;
  border: 1.5px dashed var(--border-color);
  border-radius: 12px;
  font-size: 19px;
  font-weight: bold;
  color: #232526;
  background-color: var(--input-bg);
  box-shadow: var(--input-shadow);
  transition: 
    border-color 0.2s,
    background 0.2s,
    box-shadow 0.2s;
  outline: none;
}

.input-group input:focus,
input:focus {
  border-color: var(--input-focus-border);
  background: var(--input-focus-bg);
  box-shadow: 0 0 0 2px #b3c7ff;
}

.input-group button,
.input-group .btn {
  padding: 12px 18px;
  border-radius: 12px;
  border: none;
  background: linear-gradient(90deg, #6c63ff, #4f8cff);
  color: #fff;
  font-weight: bold;
  font-size: 18px;
  cursor: pointer;
  transition: background 0.2s;
}

.input-group button:hover,
.input-group .btn:hover {
  background: linear-gradient(90deg, #4f8cff, #6c63ff);
}

label {
  display: block;
  margin-bottom: 6px;
  font-size: 15px;
  color: #d4c2b1;
  font-weight: 600;
  letter-spacing: 0.3px;
}


  button {
    background-color: var(--primary-color);
    color: white;
    border: none;
    border-radius: 4px;
    padding: 10px 15px;
    cursor: pointer;
    font-size: 16px;
    transition: background-color 0.2s;
  }

  button:hover {
    background-color: #2980b9;
  }

  .btn-secondary {
    background-color: var(--secondary-color);
  }

  .btn-secondary:hover {
    background-color: #27ae60;
  }

  .btn-danger {
    background-color: var(--accent-color);
  }

  .btn-danger:hover {
    background-color: #c0392b;
  }

  .chart-container {
    height: 460px;
    margin-top: 50px;
	margin-bottom: 30px;
    color: #ffffff;
    position: relative;
    padding: 20px 0;
    background: linear-gradient(135deg, #181c23 0%, #232a34 100%);
    border-radius: 16px;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.6);
    display: flex;
    align-items: center;
    justify-content: center;
    transition: box-shadow 0.3s ease-in-out;
}

.chart-container:hover {
    box-shadow: 0 12px 36px rgba(0, 153, 255, 0.7);
}


 .storico-chart-container {
    height: 720px;
    width: 100%;
    margin-top: 20px;
    background-color: #333;
    position: relative;
    padding: 20px;
    box-sizing: border-box;
    display: flex;
    align-items: center;
    justify-content: center;
}

  .btn-custom {
    height: 60px;
    margin-top: 18px;
    background-color: blue;       /* colore base blu */
    color: white;                 /* testo bianco per contrasto */
    border: none;
    cursor: pointer;
    font-weight: bold;
    font-size: 16px;
    padding: 10px 20px;
    border-radius: 5px;
    transition: background-color 0.3s ease;
  }

  .btn-custom:hover {
    background-color: green;      /* colore verde al passaggio del mouse */
  }


#storicoCapitaleChart {
    width: 100% !important;
    height: 100% !important;
    max-width: none !important;
    max-height: none !important;
}

/* Assicurati che il container padre sia responsive */
.storico-chart-container canvas {
    background-color: transparent;
}

  .time-range-selector {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-bottom: 15px;
    flex-wrap: wrap;
  }

  .time-range-btn {
  background-color: #222831; /* come header-stat-item */
  border: 1px solid #222831; /* bordo uguale allo sfondo per effetto "flat" */
  color: #fff; /* testo chiaro */
  border-radius: 10px; /* arrotondamento come header-stat-item */
  padding: 10px 20px; /* padding come header-stat-item */
  cursor: pointer;
  transition: all 0.2s;
  box-shadow: 0 2px 10px rgba(0,0,0,0.7); /* stessa ombra */
  margin-bottom: 20px; /* opzionale, se vuoi distanziare i bottoni */
  box-sizing: border-box;
  text-align: center;
  min-width: 140px; /* opzionale, per uniformit√† */
}

.time-range-btn.active {
  background-color: var(--primary-color);
  color: white;
  border-color: var(--primary-color);
}

  .distribution-stats {
    display: flex;
    justify-content: space-around;
    flex-wrap: wrap;
    margin: 15px 0;
  }

  .distribution-item {
    background-color: rgba(0, 0, 0, 0.03);
    padding: 10px;
    border-radius: 4px;
    text-align: center;
    min-width: 120px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    margin: 5px;
  }

  .distribution-label {
    font-size: 12px;
    color: var(--text-light);
  }

  .distribution-value {
    font-size: 16px;
    font-weight: bold;
  }

  .backup-container {
    display: flex;
    gap: 10px;
    margin-top: 10px;
    align-items: center;
	}

  #fileInput {
    flex: 1;
	font-size: 14px;
    padding: 8px;
  }

 .footer {
    margin-top: 30px;
    margin-bottom: 10px;
    text-align: center;
    font-size: 16px;
    color: #f2bb66;
    font-weight: normal;
}

.footer a {
    color: #ffe;
    text-decoration: none;
    margin: 0 8px;
    transition: color 0.3s ease;
}

.footer a:hover {
    color: #ffdb58;
}


  .tab-container {
    margin-bottom: 15px;
  }

  .tab-buttons {
    display: flex;
    border-bottom: 1px solid var(--border-color);
  }

  .tab-button {
    padding: 10px 15px;
    background: none;
    border: none;
    border-bottom: 2px solid transparent;
    cursor: pointer;
    font-weight: 500;
    color: var(--text-light);
  }

  .tab-button.active {
    color: var(--primary-color);
    border-bottom: 2px solid var(--primary-color);
  }

  .tab-content {
    padding-top: 15px;
  }

  .tab-panel {
    display: none;
  }

  .tab-panel.active {
    display: block;
  }

  @media (max-width: 768px) {
    .stats-grid {
      grid-template-columns: 1fr 1fr;
    }

    .input-group {
      flex-direction: column;
    }

    .header-stats {
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }

    .header-stat-item {
      width: 100%;
      max-width: 300px;
    }

    .time-range-selector {
      flex-wrap: wrap;
    }
  }

  @media (max-width: 480px) {
    .stats-grid {
      grid-template-columns: 1fr;
    }
  }
  
  h2 {
    color: #739bf2 !important;
    font-weight: bold !important;
    
    letter-spacing: -0.1px !important;
}

#infoTotaleTrade {
  display: none;
}

.full-box.backup-container {
  display: flex;
  flex-wrap: nowrap;
  gap: 18px;
  align-items: center;
  justify-content: center;
  padding: 32px 24px;
  background: linear-gradient(135deg, #232526 0%, #393e46 100%);
  border-radius: 18px;
  box-shadow: 0 6px 32px rgba(0,0,0,0.18);
  border: 2px solid #2c2c2c;
  margin: 24px 0 0 0;
}

.full-box.backup-container button,
.full-box.backup-container .stat-item {
  flex: 0 0 160px;  /* larghezza fissa per i bottoni */
  height: 48px;     /* altezza uniforme */
  border-radius: 10px;
  border: 2px solid #393e46;
  background: #222831;
  color: #fff;
  font-size: 1rem;
  font-weight: 600;
  box-shadow: 0 2px 10px rgba(0,0,0,0.18);
  transition: background 0.2s, border-color 0.2s, box-shadow 0.2s;
  margin: 0;
  display: flex;
  align-items: center;
  justify-content: center;
}

.full-box.backup-container button:hover {
  background: var(--primary-color, #0099ff);
  border-color: var(--primary-color, #0099ff);
  color: #fff;
  box-shadow: 0 4px 20px rgba(0,153,255,0.15);
  cursor: pointer;
}

/* Input file personalizzato */
.full-box.backup-container input[type="file"] {
  flex: 1 1 320px;         /* pi√π lungo rispetto ai bottoni */
  min-width: 220px;
  height: 48px;            /* stessa altezza dei bottoni */
  background: #232526;
  color: #bfc9d1;
  border: 2px dashed #393e46;
  border-radius: 10px;
  font-size: 1rem;
  font-weight: 500;
  padding: 0 12px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.10);
  transition: border-color 0.2s, background 0.2s, box-shadow 0.2s;
  display: flex;
  align-items: center;
  cursor: pointer;
}

/* Facoltativo: migliora la visibilit√† al focus */
.full-box.backup-container input[type="file"]:focus {
  border-color: var(--primary-color, #0099ff);
  background: #262d36;
  outline: none;
}


</style>

</head>
<body>
<div class="container">
  <div class="head2" style="color: white !important;">
    <p class="titolo-bianco"><strong>ü™∏ Panoramica del Capitale</strong></p>
  </div>
  

  
  <div class="card">
    <div class="card-header">
      <h2>Gestione Trade</h2>
    </div>
    
    <div class="input-group">
      <div class="form-group">
        <label for="inputCoinGecko" style="font-size: 18px;">CoinGecko</label>
        <input type="number" style="color: #18171c; font-size: 32px;" id="inputCoinGecko" value="22" min="0">
      </div>
      <div class="form-group">
        <label for="inputBinance" style="font-size: 18px;">Binance</label>
        <input type="number" style="color: #18171c; font-size: 32px;" id="inputBinance" value="4" min="0">
		
      </div>
    </div>
    
   <button onclick="aggiornaTrade()" class="header-stat-item" >
  üöÄ Aggiorna Trade
</button>


  </div>

  <div class="card">
    <div class="card-header">
      <h2>Distribuzione Capitale</h2>
    </div>
    
    <div class="stats-grid">
      <div class="stat-item">
        <div class="stat-label">Su CoinGecko</div>
        <div class="stat-value coingecko" style="color: #FF3A33; font-size: 39px;" id="coingecko"></div>
      </div>
      <div class="stat-item">
        <div class="stat-label">Su Binance</div>
        <div class="stat-value binance" style="color: #FFDD33; font-size: 39px;" id="binance"></div>
      </div>
      <div class="stat-item">
        <div class="stat-label">Totale in Cripto</div>
        <div class="stat-value totale" style="color: #f62817; font-size: 39px;" id="totaleIn"></div>
      </div>
      <div class="stat-item">
        <div class="stat-label">Restanti in Dollari</div>
        <div class="stat-value capitale" style="color: #1AA6ED; font-size: 39px;" id="capitale"></div>
      </div>
    </div>
    
    <div class="chart-container">
      <canvas id="capitaleChart"></canvas>
    </div>
  </div>
  
  <div class="card">
    <div class="card-header">
      <h2>Capitale Totale</h2>
    </div>
    
   <div class="header-stats">
    <div class="header-stat-item">
        <div class="header-stat-label">Trade Totali</div>
        <div class="header-stat-value" style="color: #987654; font-size: 34px;" id="totaleTrade">30</div>
    </div>
    <div class="header-stat-item">
        <div class="header-stat-label">$ per Trade</div>
        <div class="header-stat-value">
            <input type="number"  font-size: 24px;" id="quotaPerTrade" class="quota-input" value="40" min="1" oninput="aggiornaCapitale()">
        </div>
    </div>
    <div class="header-stat-item">
        <div class="header-stat-label">Capitale Totale</div>
        <div class="header-stat-value" style="color: #f5f5f5; font-size: 34px;" id="capitaleTotale"></div></div>
<div class="header-stat-item">
    <div class="header-stat-label">Capitale Restante</div>
    <div class="header-stat-value" style="color: #3BB9FF; font-size: 34px;" id="capitaleInDollari"></div>
</div>
<div class="header-stat-item">
    <div class="header-stat-label">Totale In Cripto</div>
    <div class="header-stat-value" style="color: #f62817; font-size: 34px;" id="totaleInDollari"></div>
</div>  

    <button onclick="aggiornaTrade()" class="header-stat-item" >üéØ Aggiorna Capitale</button>
    
  </div>
  
  
  
  </div>
  <!-- Nuova card per il grafico storico -->
 <div class="card">
    <div class="card-header">
      <h2>Storico Distribuzione Capitale</h2>
    </div>
    
    <div class="tab-container">
      <div class="tab-buttons">
        <button class="tab-button active" onclick="cambiaTab(event, 'tab-distribuzione')">Distribuzione nel Tempo</button>
        <button class="tab-button" onclick="cambiaTab(event, 'tab-percentuale')">Analisi Percentuale</button>
      </div>
      
      <div class="tab-content">
        <div id="tab-distribuzione" class="tab-panel active">
          <!-- GRAFICO PRIMA DEL MENU -->
          <div class="storico-chart-container">
            <canvas id="storicoCapitaleChart"></canvas>
          </div>
          
          <!-- MENU TEMPORALE SOTTO IL GRAFICO -->
          <div class="time-range-selector" style="margin-top: 30px;">
            <button class="time-range-btn active" data-days="30" onclick="cambiaRangeTempo(this)">30 Giorni</button>
            <button class="time-range-btn" data-days="90" onclick="cambiaRangeTempo(this)">90 Giorni</button>
            <button class="time-range-btn" data-days="180" onclick="cambiaRangeTempo(this)">6 Mesi</button>
            <button class="time-range-btn" data-days="365" onclick="cambiaRangeTempo(this)">1 Anno</button>
            <button class="time-range-btn" data-days="all" onclick="cambiaRangeTempo(this)">Tutto</button>
            <!-- NUOVO PULSANTE -->
            <button class="time-range-btn" onclick="scaricaGrafico()" style="margin-left: 15px;">üì∑ Scarica Grafico</button>
          </div>
          
          <!-- STATISTICHE GIORNI E MEDIE SOTTO IL MENU -->
          <div class="header-stats" style="padding-top: 2px;">
            <div class="header-stat-item">
              <div class="header-stat-label">Media Trade CoinGecko</div>
              <div class="header-stat-value" style="color: #FF3A33; font-size: 28px;" id="mediaTradeCoingecko">0</div>
            </div>
            <div class="header-stat-item">
              <div class="header-stat-label">Media Trade Binance</div>
              <div class="header-stat-value" style="color: #FFDD33; font-size: 28px;" id="mediaTradeBinance">0</div>
            </div>
            <div class="header-stat-item">
              <div class="header-stat-label">Media $ in Trading</div>
              <div class="header-stat-value" style="color: #f62817; font-size: 28px;" id="mediaDollariTrading">$0</div>
            </div>
          </div>
        </div>
        
        <div id="tab-percentuale" class="tab-panel">
          <div class="info-box">
            Analisi del tempo in cui il capitale √® stato allocato nelle seguenti percentuali in dollari.
          </div>
          
          <!-- GRAFICO PERCENTUALE SPOSTATO PRIMA DEI BOX -->
          <div class="storico-chart-container">
            <canvas id="percentualeCapitaleChart"></canvas>
          </div>
          
          
          
          <!-- BOX PERCENTUALI SPOSTATI SOTTO IL GRAFICO -->
          <div class="distribution-stats">
            <div class="distribution-item">
              <div class="distribution-label">0-25% in Dollari</div>
              <div class="distribution-value" style="color: #3BB9FF; font-size: 30px;" id="percentuale0_25">0 giorni</div>
            </div>
            <div class="distribution-item">
              <div class="distribution-label">25-50% in Dollari</div>
              <div class="distribution-value" style="color: #3BB9FF; font-size: 30px;" id="percentuale25_50">0 giorni</div>
            </div>
            <div class="distribution-item">
              <div class="distribution-label">50-75% in Dollari</div>
              <div class="distribution-value" style="color: #3BB9FF; font-size: 30px;" id="percentuale50_75">0 giorni</div>
            </div>
            <div class="distribution-item">
              <div class="distribution-label">75-100% in Dollari</div>
              <div class="distribution-value" style="color: #3BB9FF; font-size: 30px;" id="percentuale75_100">0 giorni</div>
            </div>
			<button onclick="scaricaGraficoPercentuale1()" class="header-stat-item" style="margin-top: 15px; margin-bottom: 20px;">
            <i class="fas fa-download"></i> Scarica Grafico Percentuale
          </button>
          </div>
        </div>
      </div>
    </div>
</div>
<span id="infoTotaleTrade"></span>
 

  <div class="card">
  <div class="card-header">
    <h2>Backup &amp; Ripristino</h2>
  </div>
  <p style="color: #ADD8E6;">Salva e carica i tuoi dati per trasferirli tra dispositivi diversi.</p>
  <div class="backup-container full-box">
    <button onclick="scaricaDati()" class="stat-item">Scarica Dati (JSON)</button>
    <input type="file" id="fileInput" class="stat-item" accept=".json">
    <button onclick="caricaDati()" class="stat-item">Carica Dati</button>
  </div>
</div>

</div>

 <div class="footer">
            Trading Spot Manager v1.1 | 
            <a href="https://beneinst.github.io/tradingspot/index.html">Operativit√†</a> | 
            <a href="https://beneinst.github.io/tradingspot/panoramica-capitale.html">Capitale</a> | 
			<a href="https://beneinst.github.io/tradingspot/trade.html">Trade</a> |
            <a href="https://beneinst.github.io/tradingspot/blocco-note.html">Note</a> | 
            <a href="https://beneinst.github.io/tradingspot/chartflow/index.html">Segnali</a> |
            <a href="https://beneinst.github.io/tradingspot/Strategia-Trading.html">Indicatore</a> | 
            <a href="https://beneinst.github.io/tradingspot/regole-trading.html">Regole</a> |
            <a href="https://beneinst.github.io/tradingspot/candlestick.html">Candlestick</a> | 
            <a href="https://beneinst.github.io/tradingspot/cheat-sheet.html">Patterns</a>
        </div>
    </div>


<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.9/dist/chart.umd.min.js"></script>

<script>
  // Dati principali dell'applicazione
  const datiCapitale = {
    coingecko: 0,
    binance: 0,
    totaleIn: 0,
    capitale: 0,
    totaleTrade: 30,
    quotaPerTrade: 40,
    storicoCapitale: [],
    ultimoAggiornamento: new Date().toISOString()
  };
  
  // Variabili per i grafici
  let capitaleChart = null;
  let storicoCapitaleChart = null;
  let percentualeCapitaleChart = null;
  let periodoVisualizzato = 30; // default: 30 giorni
  
  // Funzione di inizializzazione
  function inizializza() {
    // Carica dati salvati se disponibili
    caricaDatiLocali();
    
    // Se non ci sono dati storici, crea un punto iniziale
    if (datiCapitale.storicoCapitale.length === 0) {
      creaStoricoIniziale();
    }
    
    // Aggiorna l'interfaccia con i dati attuali
    aggiornaInterfaccia();
    
    // Crea il grafico iniziale
    creaGraficoCapitale();
    
    // Crea il grafico storico
    creaGraficoStoricoCapitale();
    
    // Crea il grafico percentuale
    creaGraficoPercentualeCapitale();
    
    // Calcola e mostra le statistiche sulla percentuale di tempo
    calcolaStatistichePercentuali();
  }
  
  // Crea uno storico iniziale con valori di default retroattivi
  function creaStoricoIniziale() {
    const oggi = new Date();
    const inizioStorico = new Date(oggi);
    inizioStorico.setDate(oggi.getDate() - 120); // Crea uno storico di 4 mesi
    
    // Valori di default per lo storico iniziale
    const valoriDefault = {
      coingecko: 0,
      binance: 0,
      totaleIn: 0,
      capitale: datiCapitale.totaleTrade
    };
    
    // Crea un punto dati ogni 3 giorni per gli ultimi 4 mesi
    for (let d = new Date(inizioStorico); d <= oggi; d.setDate(d.getDate() + 3)) {
      datiCapitale.storicoCapitale.push({
        data: new Date(d).toISOString(),
        coingecko: valoriDefault.coingecko,
        binance: valoriDefault.binance,
        totaleIn: valoriDefault.totaleIn,
        capitale: valoriDefault.capitale
      });
    }
    
    // Aggiungi i valori attuali come ultimo punto
    datiCapitale.storicoCapitale.push({
      data: new Date().toISOString(),
      coingecko: datiCapitale.coingecko,
      binance: datiCapitale.binance,
      totaleIn: datiCapitale.totaleIn,
      capitale: datiCapitale.capitale
    });
  }
  
  // Aggiorna i totali
  function aggiornaTotali() {
    datiCapitale.quotaPerTrade = parseFloat(document.getElementById("quotaPerTrade").value) || datiCapitale.quotaPerTrade;
    
    // Aggiorna l'interfaccia
    aggiornaInterfaccia();
    
    // Salva lo stato nei dati storici
    salvaStorico();
    
    // Salva i dati in localStorage
    salvaDatiLocali();
    
    // Aggiorna i grafici
   // aggiornaGrafico();
    aggiornaGraficoStorico();
    aggiornaGraficoPercentuale();
    
    // Ricalcola le statistiche percentuali
    calcolaStatistichePercentuali();
  }
  
  // Funzione per resettare tutti i dati
function resettaDati() {
  // Resetta i dati principali
  datiCapitale.coingecko = 0;
  datiCapitale.binance = 0;
  datiCapitale.totaleIn = 0;
  datiCapitale.capitale = datiCapitale.totaleTrade;
  datiCapitale.storicoCapitale = [];
  datiCapitale.ultimoAggiornamento = new Date().toISOString();
  
  // Crea un nuovo storico iniziale
  creaStoricoIniziale();
  
  // Aggiorna l'interfaccia e i grafici
  aggiornaInterfaccia();
 // aggiornaGrafico();
  aggiornaGraficoStorico();
  aggiornaGraficoPercentuale();
  calcolaStatistichePercentuali();
  
  // Salva i dati in localStorage
  salvaDatiLocali();
  
  alert('Dati resettati con successo!');
}

// Salva immagine del grafico
function scaricaGrafico() {
  const canvas = document.getElementById('storicoCapitaleChart');
  
  // Attiva modalit√† export e ricrea il grafico
  modalitaExport = true;
  creaGraficoStoricoCapitale();
  
  // Aspetta che il grafico sia completamente renderizzato
  setTimeout(() => {
    // Crea un canvas temporaneo con proporzioni pi√π ampie (16:9)
    const tempCanvas = document.createElement('canvas');
    const tempCtx = tempCanvas.getContext('2d');
    
    // Imposta dimensioni HD con rapporto 16:9
    tempCanvas.width = 4260;
    tempCanvas.height = 2160;
    
    // Riempie lo sfondo di BIANCO
    tempCtx.fillStyle = '#FFFFFF';
    tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
    
    // Copia il grafico originale sul canvas temporaneo
    tempCtx.drawImage(canvas, 0, 0, tempCanvas.width, tempCanvas.height);
    
    // Aggiungi il watermark
    aggiungiWatermark(tempCtx, tempCanvas.width, tempCanvas.height);
    
    // Crea il link per il download
    const link = document.createElement('a');
    const oggi = new Date();
    const dataFormattata = oggi.toISOString().split('T')[0];
    
    link.download = `grafico-capitale-HD-${dataFormattata}.png`;
    link.href = tempCanvas.toDataURL('image/png', 1.0);
    
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    // Disattiva modalit√† export e ricrea il grafico per la visualizzazione web
    modalitaExport = false;
    creaGraficoStoricoCapitale();
  }, 100); // Piccolo delay per assicurarsi che il rendering sia completo
}


  
  // Aggiorna i dati dei trade
  function aggiornaTrade() {
    const nuovoCoinGecko = parseInt(document.getElementById("inputCoinGecko").value);
    const nuovoBinance = parseInt(document.getElementById("inputBinance").value);
    
    if (!isNaN(nuovoCoinGecko)) {
      datiCapitale.coingecko = nuovoCoinGecko;
    }
    
    if (!isNaN(nuovoBinance)) {
      datiCapitale.binance = nuovoBinance;
    }
    
    // Calcola il totale in
    datiCapitale.totaleIn = datiCapitale.coingecko + datiCapitale.binance;
    
    // Aggiorna il capitale disponibile
    calcolaCapitale();
    
    // Aggiorna l'ultimo aggiornamento
    datiCapitale.ultimoAggiornamento = new Date().toISOString();
    
    // Aggiorna l'interfaccia
    aggiornaInterfaccia();
    
    // Salva lo stato nei dati storici
    salvaStorico();
    
    // Salva i dati in localStorage
    salvaDatiLocali();
    
    // Aggiorna i grafici
 //   aggiornaGrafico();
    aggiornaGraficoStorico();
    aggiornaGraficoPercentuale();
    
    // Ricalcola le statistiche percentuali
    calcolaStatistichePercentuali();
	setTimeout(() => {
  salvaDatiLocali();
  aggiornaGraficoStorico();
}, 100);
  }
  
  // Calcola il capitale disponibile
  function calcolaCapitale() {
    datiCapitale.capitale = datiCapitale.totaleTrade - datiCapitale.totaleIn;
  }
  
  function verificaDatiStorico() {
  console.log('Dati storico attuali:', datiCapitale.storicoCapitale);
  console.log('Ultimo aggiornamento:', datiCapitale.ultimoAggiornamento);
  console.log('LocalStorage:', JSON.parse(localStorage.getItem('datiCapitale')));
}

  // Aggiorna tutti gli elementi dell'interfaccia
  function aggiornaInterfaccia() {
    document.getElementById("coingecko").textContent = datiCapitale.coingecko;
    document.getElementById("binance").textContent = datiCapitale.binance;
    document.getElementById("totaleIn").textContent = datiCapitale.totaleIn;
    document.getElementById("capitale").textContent = datiCapitale.capitale;
    document.getElementById("totaleTrade").textContent = datiCapitale.totaleTrade;
    document.getElementById("infoTotaleTrade").textContent = datiCapitale.totaleTrade;
    document.getElementById("quotaPerTrade").value = datiCapitale.quotaPerTrade;
    
    // Aggiorna anche i valori degli input
    document.getElementById("inputCoinGecko").value = datiCapitale.coingecko;
    document.getElementById("inputBinance").value = datiCapitale.binance;
    
    // Calcola e aggiorna le medie
    const datiPeriodo = filtraDatiPerPeriodo(datiCapitale.storicoCapitale, periodoVisualizzato);
    
    if (datiPeriodo.length > 0) {
      const mediaCoingecko = calcolaMedia(datiPeriodo.map(item => item.coingecko));
      const mediaBinance = calcolaMedia(datiPeriodo.map(item => item.binance));
      const mediaDollari = (mediaCoingecko + mediaBinance) * datiCapitale.quotaPerTrade;
      
      document.getElementById("mediaTradeCoingecko").textContent = mediaCoingecko.toFixed(1);
      document.getElementById("mediaTradeBinance").textContent = mediaBinance.toFixed(1);
      document.getElementById("mediaDollariTrading").textContent = `$${mediaDollari.toFixed(2)}`;
    }
  }
  
  // Calcola la media di un array di numeri
  function calcolaMedia(array) {
    if (array.length === 0) return 0;
    return array.reduce((sum, val) => sum + val, 0) / array.length;
  }
  
 // Salva lo stato attuale nei dati storici
function salvaStorico() {
  const oggi = new Date();
  const timestamp = oggi.toISOString();
  
  // Controlla se c'√® gi√† un record per oggi
  const oggiString = oggi.toISOString().split('T')[0];
  const recordOggi = datiCapitale.storicoCapitale.find(record => 
    record.data.split('T')[0] === oggiString
  );
  
  if (recordOggi) {
    // Aggiorna il record esistente per oggi
    recordOggi.coingecko = datiCapitale.coingecko;
    recordOggi.binance = datiCapitale.binance;
    recordOggi.totaleIn = datiCapitale.totaleIn;
    recordOggi.capitale = datiCapitale.capitale;
  } else {
    // Aggiungi un nuovo record per oggi
    datiCapitale.storicoCapitale.push({
      data: timestamp,
      coingecko: datiCapitale.coingecko,
      binance: datiCapitale.binance,
      totaleIn: datiCapitale.totaleIn,
      capitale: datiCapitale.capitale
    });
  }
  
  // Ordina lo storico per data
  datiCapitale.storicoCapitale.sort((a, b) => new Date(a.data) - new Date(b.data));
}
  
  // Filtra i dati storici per il periodo visualizzato
  function filtraDatiPerPeriodo(dati, giorni) {
    if (!dati || dati.length === 0) return [];
    
    if (giorni === 'all') return dati;
    
    const oggi = new Date();
    const dataLimite = new Date(oggi);
    dataLimite.setDate(oggi.getDate() - giorni);
    
    return dati.filter(item => new Date(item.data) >= dataLimite);
  }
  
 function creaGraficoCapitale() {
  const ctx = document.getElementById('capitaleChart').getContext('2d');

  if (capitaleChart) {
    capitaleChart.destroy();
  }

  capitaleChart = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: ['CoinGecko (Crypto)', 'Binance (Crypto)', 'A Capitale (USD)'],
      datasets: [{
        data: [
          datiCapitale.coingecko,
          datiCapitale.binance,
          datiCapitale.capitale
        ],
        backgroundColor: [
          '#FF3A33',
          '#FFDD33',
          '#1AA6ED'
        ],
        borderColor: '#222', // bordo molto scuro
        borderWidth: 5,
        hoverOffset: 22
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'right',
          labels: {
            color: '#ebaa68', // grigio molto scuro
            font: {
              size: 15,
              family: 'Trebuchet MS'
    },
    padding: 8,                 // Riduci la distanza verticale tra le voci
    boxWidth: 16,               // Dimensione del punto
    boxHeight: 16,              // Dimensione del punto
    usePointStyle: true,        // Usa punti invece di rettangoli
    pointStyle: 'circle'        // Imposta la forma a cerchio
  }
        },
        tooltip: {
  backgroundColor: '#181c23',
  titleColor: '#739bf2',
  bodyColor: '#F0F8FF',
  borderColor: '#2980b9',
  borderWidth: 2,
  cornerRadius: 10,
  padding: 18,
  displayColors: true,
  bodyFont: {
    size: 18 // Imposta l'altezza del testo delle etichette a 18px
  },
  callbacks: {
    label: function (context) {
      const label = context.label || '';
      const value = context.raw || 0;
      const total = context.dataset.data.reduce((a, b) => a + b, 0);
      const percentage = ((value / total) * 100).toFixed(1);
      const dollari = (value * datiCapitale.quotaPerTrade).toFixed(2);
      return `${label}: ${value} trade (${percentage}%) = $${dollari}`;
            }
          }
        }
      },
      cutout: '55%',
      layout: {
        padding: 10
      }
    }
  });
}

// Funzione per scaricare il grafico percentuale
// Funzione per scaricare il grafico percentuale con dimensioni HD e sfondo bianco
function scaricaGraficoPercentuale1() {
  console.log('Funzione scaricaGraficoPercentuale chiamata'); // Debug
  
  // Verifica che la variabile del grafico esista
  if (typeof percentualeCapitaleChart === 'undefined' || !percentualeCapitaleChart) {
    console.error('Grafico percentualeCapitaleChart non trovato - assicurati che sia stato creato');
    alert('Grafico non disponibile per il download. Assicurati che il grafico sia visualizzato.');
    return;
  }
  
  try {
    // Crea un canvas temporaneo con proporzioni pi√π ampie (16:9)
    const tempCanvas = document.createElement('canvas');
    const tempCtx = tempCanvas.getContext('2d');
    
    // Imposta dimensioni HD con rapporto 16:9
    tempCanvas.width = 4260;
    tempCanvas.height = 2160;
    
    // Riempie lo sfondo di BIANCO
    tempCtx.fillStyle = '#FFFFFF';
    tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
    
    // Ottieni l'immagine del grafico originale
    const chartImageUrl = percentualeCapitaleChart.toBase64Image('image/png', 1.0);
    
    // Crea un'immagine temporanea per disegnare sul canvas
    const img = new Image();
    img.onload = function() {
      // Disegna l'immagine del grafico sul canvas temporaneo
      tempCtx.drawImage(img, 0, 0, tempCanvas.width, tempCanvas.height);
      
      // Aggiungi il watermark se la funzione esiste
      if (typeof aggiungiWatermark === 'function') {
        aggiungiWatermark(tempCtx, tempCanvas.width, tempCanvas.height);
      }
      
      // Crea il link per il download
      const link = document.createElement('a');
      const oggi = new Date();
      const dataFormattata = oggi.toISOString().split('T')[0];
      
      link.download = `grafico-percentuale-capitale-HD-${dataFormattata}.png`;
      link.href = tempCanvas.toDataURL('image/png', 1.0);
      
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      console.log('Download completato');
    };
    
    img.onerror = function() {
      console.error('Errore nel caricamento dell\'immagine del grafico');
      alert('Errore nel caricamento dell\'immagine del grafico');
    };
    
    // Carica l'immagine del grafico
    img.src = chartImageUrl;
    
  } catch (error) {
    console.error('Errore durante il download:', error);
    alert('Errore durante il download del grafico: ' + error.message);
  }
}
// NOTA: Nel tuo codice creaGraficoPercentualeCapitale() c'√® un errore:
// Cambia "borderColor: 2," in "borderColor: '#3498db'," o un altro colore valido

// Pulsante HTML da aggiungere nella sezione del grafico percentuale
/*
<button onclick="scaricaGraficoPercentuale()" class="btn btn-secondary">
  <i class="fas fa-download"></i> Scarica Grafico Percentuale
</button>
*/

// Funzione per scaricare il grafico percentuale
function scaricaGraficoPercentuale() {
  const canvas = document.getElementById('percentualeCapitaleChart');
  
  // Attiva modalit√† export e ricrea il grafico
  modalitaExport = true;
  creaGraficoPercentualeCapitale();
  
  // Aspetta che il grafico sia completamente renderizzato
  setTimeout(() => {
    // Crea un canvas temporaneo con proporzioni pi√π ampie (16:9)
    const tempCanvas = document.createElement('canvas');
    const tempCtx = tempCanvas.getContext('2d');
    
    // Imposta dimensioni HD con rapporto 16:9
    tempCanvas.width = 4260;
    tempCanvas.height = 2160;
    
    // Riempie lo sfondo di BIANCO
    tempCtx.fillStyle = '#FFFFFF';
    tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
    
    // Copia il grafico originale sul canvas temporaneo
    tempCtx.drawImage(canvas, 0, 0, tempCanvas.width, tempCanvas.height);
    
    // Aggiungi il watermark
    aggiungiWatermark(tempCtx, tempCanvas.width, tempCanvas.height);
    
    // Crea il link per il download
    const link = document.createElement('a');
    const oggi = new Date();
    const dataFormattata = oggi.toISOString().split('T')[0];
    
    link.download = `grafico-percentuale-capitale-HD-${dataFormattata}.png`;
    link.href = tempCanvas.toDataURL('image/png', 1.0);
    
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    // Disattiva modalit√† export e ricrea il grafico per la visualizzazione web
    modalitaExport = false;
    creaGraficoPercentualeCapitale();
  }, 100); // Piccolo delay per assicurarsi che il rendering sia completo
}
  
  // Crea il grafico storico della distribuzione del capitale
  // Configurazione colori per web e export
const coloriConfig = {
  web: {
    testo: '#fff',
    griglia: 'rgba(68, 68, 68, 0.8)',
    sfondo: 'transparent'
  },
  export: {
    testo: '#000',
    griglia: 'rgba(200, 200, 200, 0.8)',
    sfondo: '#ffffff'
  }
};

let modalitaExport = false; // Flag per sapere se stiamo esportando

function creaGraficoStoricoCapitale() {
  const canvas = document.getElementById('storicoCapitaleChart');
  const ctx = canvas.getContext('2d');

  const datiPeriodo = filtraDatiPerPeriodo(datiCapitale.storicoCapitale, periodoVisualizzato);

  if (storicoCapitaleChart) {
    storicoCapitaleChart.destroy();
  }

  // Scegli i colori in base alla modalit√†
  const colori = modalitaExport ? coloriConfig.export : coloriConfig.web;

  storicoCapitaleChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: datiPeriodo.map(item => {
        const data = new Date(item.data);
        return `${data.getDate()}/${data.getMonth() + 1}`;
      }),
      datasets: [
        {
          label: 'CoinGecko',
          data: datiPeriodo.map(item => item.coingecko),
          backgroundColor: 'rgba(161, 201, 53, 0.2)',
          borderColor: '#A1C935',
          borderWidth: 3,
          tension: 0.4,
          pointRadius: 4,
          pointHoverRadius: 6
        },
        {
          label: 'Binance',
          data: datiPeriodo.map(item => item.binance),
          backgroundColor: 'rgba(251, 185, 23, 0.2)',
          borderColor: '#FBB917',
          borderWidth: 3,
          tension: 0.4,
          pointRadius: 4,
          pointHoverRadius: 6
        },
        {
          label: 'Cripto',
          data: datiPeriodo.map(item => item.totaleIn),
          backgroundColor: 'rgba(246, 40, 23, 0.2)',
          borderColor: '#F62817',
          borderWidth: 3,
          tension: 0.4,
          pointRadius: 4,
          pointHoverRadius: 6
        },
        {
          label: 'Dollari',
          data: datiPeriodo.map(item => item.capitale),
          backgroundColor: 'rgba(0, 128, 128, 0.2)',
          borderColor: '#1AA6ED',
          borderWidth: 3,
          tension: 0.4,
          pointRadius: 4,
          pointHoverRadius: 6
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      
      interaction: {
        mode: 'index',
        intersect: false
      },
      hover: {
        mode: 'index',
        intersect: false,
        animationDuration: 300
      },
      animation: {
        duration: modalitaExport ? 0 : 800, // No animazione durante export
        easing: 'easeOutQuart'
      },
      plugins: {
        legend: {
          display: true,
          position: 'top',
          labels: {
            color: colori.testo,
            font: {
              size: 14,
              family: 'Poppins, Arial, sans-serif'
            },
            padding: 15,
            boxWidth: 25,
            boxHeight: 12,
            usePointStyle: false
          }
        },
        tooltip: {
          enabled: !modalitaExport, // Disabilita tooltip durante export
          backgroundColor: 'rgba(51, 51, 51, 0.95)',
          titleColor: '#fff',
          bodyColor: '#fff',
          borderColor: '#666',
          borderWidth: 1,
          cornerRadius: 8,
          displayColors: true,
          callbacks: {
            label: function(context) {
              const label = context.dataset.label || '';
              const value = context.parsed.y || 0;
              return `${label}: ${value.toFixed(2)}`;
            }
          }
        }
      },
      layout: {
        padding: {
          top: modalitaExport ? 2 : 5, // Pi√π spazio in alto per il watermark
          right: modalitaExport ? 5 : 10,
          bottom: modalitaExport ? 2 : 5,
          left: modalitaExport ? 5 : 5
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          max: 30,
          title: {
            display: true,
            text: 'Numero di Trade',
            color: colori.testo,
            font: {
              size: modalitaExport ? 14.5 : 12
            }
          },
          ticks: {
            color: colori.testo,
            font: {
              size: modalitaExport ? 14.5 : 12
            }
          },
          grid: {
            color: colori.griglia
          }
        },
        x: {
          title: {
            display: true,
            text: 'Data',
            color: colori.testo,
            font: {
              size: modalitaExport ? 14.5 : 12
            }
          },
          ticks: {
            color: colori.testo,
            font: {
              size: modalitaExport ? 14.5 : 12
            },
            maxRotation: 45,
            minRotation: 0
          },
          grid: {
            color: colori.griglia
          }
        }
      }
    }
  });
}

// Funzione per aggiungere watermark al canvas
function aggiungiWatermark(ctx, width, height) {
  const oggi = new Date();
  const dataFormattata = oggi.toLocaleDateString('it-IT');
  
  // Salva il contesto corrente
  ctx.save();
  
  // Configura il testo del watermark
  ctx.font = '34px "Courier New", monospace';
  ctx.fillStyle = '#666666';
  ctx.textAlign = 'right';
  ctx.textBaseline = 'bottom';
  
  // Testo del watermark
  const watermarkText = `üìà gerardo_dorrico data: ${dataFormattata}`;
  
  // Posiziona il watermark in basso a destra
  const padding = 30;
  ctx.fillText(watermarkText, width - padding, height - padding);
  
  // Ripristina il contesto
  ctx.restore();
}



  
  // Aggiorna il grafico storico
  function aggiornaGraficoStorico() {
    if (storicoCapitaleChart) {
      const datiPeriodo = filtraDatiPerPeriodo(datiCapitale.storicoCapitale, periodoVisualizzato);
      
      storicoCapitaleChart.data.labels = datiPeriodo.map(item => {
        const data = new Date(item.data);
        return `${data.getDate()}/${data.getMonth() + 1}`;
      });
      
      storicoCapitaleChart.data.datasets[0].data = datiPeriodo.map(item => item.coingecko);
      storicoCapitaleChart.data.datasets[1].data = datiPeriodo.map(item => item.binance);
      storicoCapitaleChart.data.datasets[2].data = datiPeriodo.map(item => item.totaleIn);
      storicoCapitaleChart.data.datasets[3].data = datiPeriodo.map(item => item.capitale);
      
      storicoCapitaleChart.update();
    }
  }
  
  // Cambia il range di tempo visualizzato
  function cambiaRangeTempo(elemento) {
    // Rimuovi la classe active da tutti i bottoni
    document.querySelectorAll('.time-range-btn').forEach(btn => {
      btn.classList.remove('active');
    });
    
    // Aggiungi la classe active all'elemento cliccato
    elemento.classList.add('active');
    
    // Aggiorna il periodo visualizzato
    periodoVisualizzato = elemento.dataset.days;
    
    // Aggiorna i grafici
    aggiornaGraficoStorico();
    aggiornaGraficoPercentuale();
    
    // Aggiorna le statistiche
    aggiornaInterfaccia();
    
    // Ricalcola le statistiche percentuali
    calcolaStatistichePercentuali();
  }
  
  // Cambia tab attivo
  function cambiaTab(event, tabId) {
    // Nascondi tutti i pannelli
    document.querySelectorAll('.tab-panel').forEach(panel => {
      panel.classList.remove('active');
    });
    
    // Rimuovi active da tutti i bottoni
    document.querySelectorAll('.tab-button').forEach(btn => {
      btn.classList.remove('active');
    });
    
    // Mostra il pannello selezionato
    document.getElementById(tabId).classList.add('active');
    
    // Attiva il bottone cliccato
    event.currentTarget.classList.add('active');
    
    // Aggiorna i grafici se necessario
    if (tabId === 'tab-distribuzione') {
      aggiornaGraficoStorico();
    } else if (tabId === 'tab-percentuale') {
      aggiornaGraficoPercentuale();
      calcolaStatistichePercentuali();
    }
  }
  
  // Crea il grafico percentuale
  function creaGraficoPercentualeCapitale() {
    const ctx = document.getElementById('percentualeCapitaleChart').getContext('2d');
    const datiPeriodo = filtraDatiPerPeriodo(datiCapitale.storicoCapitale, periodoVisualizzato);
    
    // Calcola le percentuali del capitale in dollari
    const percentuali = datiPeriodo.map(item => {
      const totaleInDollari = item.totaleIn * datiCapitale.quotaPerTrade;
      const totaleComplessivo = datiCapitale.totaleTrade * datiCapitale.quotaPerTrade;
      return (totaleInDollari / totaleComplessivo) * 100;
    });
    
    percentualeCapitaleChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: datiPeriodo.map(item => {
          const data = new Date(item.data);
          return `${data.getDate()}/${data.getMonth() + 1}`;
        }),
        datasets: [{
          label: '% Capitale in Trading',
          data: percentuali,
          backgroundColor: 'rgba(213, 240, 255, 0.4)',
          borderColor: 'rgba(0,65,194, 1)',
          tension: 0.4,
          fill: true,
          pointRadius: 4
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true,
            max: 100,
            title: {
              display: true,
              text: 'Percentuale in Trading (%)'
            }
          },
          x: {
            title: {
              display: true,
              text: 'Data'
            }
          }
        },
        plugins: {
          tooltip: {
            callbacks: {
              label: function(context) {
                const value = context.raw || 0;
                return `Capitale in Trading: ${value.toFixed(1)}%`;
              }
            }
          }
        }
      }
    });
  }
  
  // Aggiorna il grafico percentuale
  function aggiornaGraficoPercentuale() {
    if (percentualeCapitaleChart) {
      const datiPeriodo = filtraDatiPerPeriodo(datiCapitale.storicoCapitale, periodoVisualizzato);
      
      // Aggiorna le etichette
      percentualeCapitaleChart.data.labels = datiPeriodo.map(item => {
        const data = new Date(item.data);
        return `${data.getDate()}/${data.getMonth() + 1}`;
      });
      
      // Calcola le nuove percentuali
      const percentuali = datiPeriodo.map(item => {
        const totaleInDollari = item.totaleIn * datiCapitale.quotaPerTrade;
        const totaleComplessivo = datiCapitale.totaleTrade * datiCapitale.quotaPerTrade;
        return (totaleInDollari / totaleComplessivo) * 100;
      });
      
      percentualeCapitaleChart.data.datasets[0].data = percentuali;
      percentualeCapitaleChart.update();
    }
  }
  
  // Calcola le statistiche per le percentuali di tempo
  function calcolaStatistichePercentuali() {
    const datiPeriodo = filtraDatiPerPeriodo(datiCapitale.storicoCapitale, periodoVisualizzato);
    
    if (datiPeriodo.length === 0) {
      return;
    }
    
    // Contatori per ciascuna fascia percentuale
    let count0_25 = 0;
    let count25_50 = 0;
    let count50_75 = 0;
    let count75_100 = 0;
    
    // Calcola le percentuali per ogni giorno e incrementa i contatori
    datiPeriodo.forEach(item => {
      const totaleInDollari = item.totaleIn * datiCapitale.quotaPerTrade;
      const totaleComplessivo = datiCapitale.totaleTrade * datiCapitale.quotaPerTrade;
      const percentuale = (totaleInDollari / totaleComplessivo) * 100;
      
      if (percentuale <= 25) {
        count0_25++;
      } else if (percentuale <= 50) {
        count25_50++;
      } else if (percentuale <= 75) {
        count50_75++;
      } else {
        count75_100++;
      }
    });
    
    // Aggiorna i contatori nell'interfaccia
    document.getElementById("percentuale0_25").textContent = `${count0_25} giorni`;
    document.getElementById("percentuale25_50").textContent = `${count25_50} giorni`;
    document.getElementById("percentuale50_75").textContent = `${count50_75} giorni`;
    document.getElementById("percentuale75_100").textContent = `${count75_100} giorni`;
  }
  
	// Totale del Capitale
   function aggiornaCapitale() {
    // Recupera il valore dei "Trade Totali"
    const tradeTotali = parseInt(document.getElementById('totaleTrade').innerText);

    // Recupera il valore della "Quota per Trade"
    const quotaPerTrade = parseInt(document.getElementById('quotaPerTrade').value);

    // Salva il valore quotaPerTrade nei dati principali
    datiCapitale.quotaPerTrade = quotaPerTrade;

    // Calcola il "Capitale Totale"
    const capitaleTotale = tradeTotali * quotaPerTrade;

    // Calcola "A Capitale" in dollari
    const capitaleInDollari = datiCapitale.capitale * quotaPerTrade;

    // Calcola "Totale In" in dollari
    const totaleInDollari = datiCapitale.totaleIn * quotaPerTrade;

    // Aggiorna tutti i valori nell'interfaccia
    document.getElementById('capitaleTotale').innerText = capitaleTotale;
    document.getElementById('capitaleInDollari').innerText = `$${capitaleInDollari}`;
    document.getElementById('totaleInDollari').innerText = `$${totaleInDollari}`;

    // Salva i dati aggiornati
    salvaDatiLocali();
}

// Modifica la funzione aggiornaInterfaccia() per includere i nuovi campi
function aggiornaInterfaccia() {
    document.getElementById("coingecko").textContent = datiCapitale.coingecko;
    document.getElementById("binance").textContent = datiCapitale.binance;
    document.getElementById("totaleIn").textContent = datiCapitale.totaleIn;
    document.getElementById("capitale").textContent = datiCapitale.capitale;
    document.getElementById("totaleTrade").textContent = datiCapitale.totaleTrade;
    document.getElementById("infoTotaleTrade").textContent = datiCapitale.totaleTrade;
    document.getElementById("quotaPerTrade").value = datiCapitale.quotaPerTrade;
    
    // Aggiorna anche i valori degli input
    document.getElementById("inputCoinGecko").value = datiCapitale.coingecko;
    document.getElementById("inputBinance").value = datiCapitale.binance;
    
    // Calcola e aggiorna i nuovi valori in dollari
    const capitaleTotale = datiCapitale.totaleTrade * datiCapitale.quotaPerTrade;
    const capitaleInDollari = datiCapitale.capitale * datiCapitale.quotaPerTrade;
    const totaleInDollari = datiCapitale.totaleIn * datiCapitale.quotaPerTrade;
    
    // Aggiorna i nuovi elementi dell'interfaccia
    document.getElementById('capitaleTotale').innerText = capitaleTotale;
    document.getElementById('capitaleInDollari').innerText = `$${capitaleInDollari}`;
    document.getElementById('totaleInDollari').innerText = `$${totaleInDollari}`;
    
    // Calcola e aggiorna le medie (codice esistente)
    const datiPeriodo = filtraDatiPerPeriodo(datiCapitale.storicoCapitale, periodoVisualizzato);
    
    if (datiPeriodo.length > 0) {
      const mediaCoingecko = calcolaMedia(datiPeriodo.map(item => item.coingecko));
      const mediaBinance = calcolaMedia(datiPeriodo.map(item => item.binance));
      const mediaDollari = (mediaCoingecko + mediaBinance) * datiCapitale.quotaPerTrade;
      
      document.getElementById("mediaTradeCoingecko").textContent = mediaCoingecko.toFixed(1);
      document.getElementById("mediaTradeBinance").textContent = mediaBinance.toFixed(1);
      document.getElementById("mediaDollariTrading").textContent = `$${mediaDollari.toFixed(2)}`;
    }
}

// Modifica la funzione aggiornaTotali() per salvare quotaPerTrade
function aggiornaTotali() {
    datiCapitale.quotaPerTrade = parseFloat(document.getElementById("quotaPerTrade").value) || datiCapitale.quotaPerTrade;
    
    // Aggiorna l'interfaccia
    aggiornaInterfaccia();
    
    // Salva lo stato nei dati storici
    salvaStorico();
    
    // Salva i dati in localStorage
    salvaDatiLocali();
    
    // Aggiorna i grafici
   // aggiornaGrafico();
    aggiornaGraficoStorico();
    aggiornaGraficoPercentuale();
    
    // Ricalcola le statistiche percentuali
    calcolaStatistichePercentuali();
}


  // Salva i dati in localStorage
  function salvaDatiLocali() {
    localStorage.setItem('datiCapitale', JSON.stringify(datiCapitale));
  }
  
  // Carica i dati da localStorage
  function caricaDatiLocali() {
    const datiSalvati = localStorage.getItem('datiCapitale');
    if (datiSalvati) {
      const datiParsati = JSON.parse(datiSalvati);
      
      // Aggiorna i dati dell'applicazione
      Object.assign(datiCapitale, datiParsati);
    }
  }
  
  // Scarica i dati come file JSON
  function scaricaDati() {
    const dataStr = JSON.stringify(datiCapitale, null, 2);
    const dataBlob = new Blob([dataStr], {type: 'application/json'});
    const url = URL.createObjectURL(dataBlob);
    
    const a = document.createElement('a');
    a.href = url;
	
    a.download = `capitale-trading-${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }
  
  // Carica i dati da un file JSON
  function caricaDati() {
    const fileInput = document.getElementById('fileInput');
    const file = fileInput.files[0];
    
    if (!file) {
      alert('Seleziona un file JSON prima di procedere.');
      return;
    }
    
    const reader = new FileReader();
    reader.onload = function(e) {
      try {
        const datiCaricati = JSON.parse(e.target.result);
        
        // Verifica che i dati caricati abbiano la struttura corretta
        if (!datiCaricati.hasOwnProperty('coingecko') || 
            !datiCaricati.hasOwnProperty('binance') || 
            !datiCaricati.hasOwnProperty('totaleIn') || 
            !datiCaricati.hasOwnProperty('capitale')) {
          alert('Il file non contiene dati validi.');
          return;
        }
        
        // Aggiorna i dati dell'applicazione
        Object.assign(datiCapitale, datiCaricati);
        
        // Aggiorna l'interfaccia
        aggiornaInterfaccia();
        
        // Aggiorna i grafici
       // aggiornaGrafico();
        aggiornaGraficoStorico();
        aggiornaGraficoPercentuale();
        
        // Ricalcola le statistiche percentuali
        calcolaStatistichePercentuali();
        
        // Salva i dati in localStorage
        salvaDatiLocali();
     
        alert('Dati caricati con successo!');
      } catch (error) {
        alert('Errore durante il caricamento dei dati: ' + error.message);
      }
    };
    
    reader.readAsText(file);
  }
  
  // Funzione per aggiungere un indicatore del tempo del capitale
  function aggiungiIndicatoreTempo() {
    // Ottieni i dati pi√π recenti
    const datiRecenti = filtraDatiPerPeriodo(datiCapitale.storicoCapitale, 30); // ultimi 30 giorni
    
    if (datiRecenti.length < 2) return; // Servono almeno 2 punti dati per calcolare una tendenza
    
    // Calcola il trend del capitale in trading
    const primoValore = datiRecenti[0].totaleIn;
    const ultimoValore = datiRecenti[datiRecenti.length - 1].totaleIn;
    const differenza = ultimoValore - primoValore;
    
    // Calcola la velocit√† media di variazione (trade al giorno)
    const giorniPassati = (new Date(datiRecenti[datiRecenti.length - 1].data) - new Date(datiRecenti[0].data)) / (1000 * 60 * 60 * 24);
    const velocitaMediaGiornaliera = giorniPassati > 0 ? differenza / giorniPassati : 0;
    
    // Calcola il tempo stimato per raggiungere il 100% o tornare allo 0% del capitale in trading
    let tempoStimato = 0;
    let messaggio = "";
    
    if (velocitaMediaGiornaliera > 0) {
      // Stiamo aumentando il capitale in trading, calcoliamo quanto tempo per arrivare al 100%
      const tradeRimanenti = datiCapitale.totaleTrade - ultimoValore;
      tempoStimato = velocitaMediaGiornaliera > 0 ? Math.ceil(tradeRimanenti / velocitaMediaGiornaliera) : Infinity;
      messaggio = `Al ritmo attuale, il 100% del capitale sar√† in trading tra circa ${tempoStimato} giorni`;
    } else if (velocitaMediaGiornaliera < 0) {
      // Stiamo diminuendo il capitale in trading, calcoliamo quanto tempo per tornare allo 0%
      tempoStimato = velocitaMediaGiornaliera < 0 ? Math.ceil(ultimoValore / Math.abs(velocitaMediaGiornaliera)) : Infinity;
      messaggio = `Al ritmo attuale, il capitale in trading sar√† esaurito tra circa ${tempoStimato} giorni`;
    } else {
      messaggio = "Il capitale in trading √® stabile, nessuna variazione rilevata nell'ultimo periodo";
    }
    
    // Crea o aggiorna l'elemento HTML per l'indicatore del tempo
    let indicatoreElement = document.getElementById("indicatoreTempo");
    if (!indicatoreElement) {
      indicatoreElement = document.createElement("div");
      indicatoreElement.id = "indicatoreTempo";
      indicatoreElement.className = "info-box";
      
      // Inseriscilo prima del grafico percentuale
      const container = document.getElementById("tab-percentuale");
      const graficoContainer = container.querySelector(".storico-chart-container");
      container.insertBefore(indicatoreElement, graficoContainer);
    }
    
    // Aggiorna il contenuto dell'indicatore
    indicatoreElement.innerHTML = `
      <strong>Indicatore di Tendenza:</strong> ${messaggio}<br>
      <span class="distribution-label">Variazione media: ${velocitaMediaGiornaliera.toFixed(2)} trade al giorno</span>
    `;
    
    // Aggiungi un colore in base alla tendenza
    if (velocitaMediaGiornaliera > 0) {
      indicatoreElement.style.borderLeft = "4px solid var(--accent-color)";
    } else if (velocitaMediaGiornaliera < 0) {
      indicatoreElement.style.borderLeft = "4px solid var(--secondary-color)";
    } else {
      indicatoreElement.style.borderLeft = "4px solid var(--primary-color)";
    }
  }
  
  // Inizializza l'applicazione quando il documento √® pronto
  document.addEventListener('DOMContentLoaded', function() {
    inizializza();
// 	window.addEventListener('resize', gestisciRidimensionamento);
    
    // Aggiungi l'indicatore del tempo dopo l'inizializzazione
    aggiungiIndicatoreTempo();
    
    // Aggiorna l'indicatore quando cambia il range di tempo
    document.querySelectorAll('.time-range-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        aggiungiIndicatoreTempo();
      });
    });
  });
    </script>

</body>
</html>