<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Masaniello Dinamico</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #2D2D2D 0%, #1A1A1A 100%);
      min-height: 100vh;
      padding: 20px;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      background: #FFFFFF;
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
	
	 .container-f {
      max-width: 900px;
      margin: 0 auto;
      background: linear-gradient(135deg, #2D2D2D 0%, #1A1A1A 100%);
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    h1 {
      color: #00A000;
      text-align: center;
      margin-bottom: 10px;
      font-size: 2.2em;
    }
    .subtitle {
      text-align: center;
      color: #666;
      margin-bottom: 30px;
      font-size: 1.1em;
    }
    .section {
      background: #F5F5F5;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
    }
    .input-group {
      margin-bottom: 15px;
    }
    label {
      display: block;
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
      font-size: 1.05em;
    }
    input {
      width: 100%;
      padding: 12px;
      border: 2px solid #E0E0E0;
      border-radius: 8px;
      font-size: 1em;
      transition: all 0.3s;
    }
    input:focus {
      outline: none;
      border-color: #00A000;
      box-shadow: 0 0 0 3px rgba(0, 160, 0, 0.1);
    }
    .btn {
      width: 100%;
      padding: 15px;
      background: linear-gradient(135deg, #00A000, #007A00);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 1.1em;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s;
    }
    .btn:hover { transform: translateY(-2px); }
    .btn:active { transform: translateY(0); }
    .btn-result {
      width: auto;
      padding: 12px 30px;
      margin: 10px;
      font-size: 1em;
    }
    .btn-win { 
  background: linear-gradient(135deg, #00C853, #009624);
  border: 2px solid #00FF88;
  box-shadow: inset 0 0 0 2px #007A00, 0 4px 15px rgba(0, 200, 83, 0.3);
}

.btn-loss { 
  background: linear-gradient(135deg, #D32F2F, #B71C1C);
  border: 2px solid #FF6B6B;
  box-shadow: inset 0 0 0 2px #8B0000, 0 4px 15px rgba(211, 47, 47, 0.3);
}
    .current-bet {
  background: linear-gradient(135deg, rgba(255, 228, 24, 0.8) 0%, rgba(0, 84, 64, 0.9) 60%);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px); /* Per Safari */
  color: white;
  padding: 25px;
  border-radius: 12px;
  text-align: center;
  margin: 20px 0;
  border: 1px solid rgba(255, 255, 255, 0.2); /* Bordo sottile */
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
}
    .current-bet h2 { margin-bottom: 15px; font-size: 1.5em; }
    .bet-amount {
      font-size: 3em;
      font-weight: bold;
      margin: 15px 0;
    }
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }
    .stat-box {
      background: white;
      padding: 15px;
      border-radius: 10px;
      text-align: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .stat-label {
      font-size: 0.9em;
      color: #666;
      margin-bottom: 5px;
    }
    .stat-value {
      font-size: 1.5em;
      font-weight: bold;
      color: #00A000;
    }
    .history {
      margin-top: 20px;
    }
    .history-item {
      background: white;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .history-win { border-left: 5px solid #00C853; }
    .history-loss { border-left: 5px solid #D32F2F; }
    .badge {
      padding: 5px 15px;
      border-radius: 20px;
      font-weight: 600;
      font-size: 0.9em;
    }
    .badge-win { background: #00C853; color: white; }
    .badge-loss { background: #D32F2F; color: white; }
    .hidden { display: none; }
    .warning {
      background: #FFF3CD;
      border-left: 5px solid #FFA000;
      padding: 15px;
      border-radius: 8px;
      margin: 20px 0;
    }
    .success {
      background: #D4EDDA;
      border-left: 5px solid #009624;
      padding: 15px;
      border-radius: 8px;
      margin: 20px 0;
      text-align: center;
    }
    .danger {
      background: #F8D7DA;
      border-left: 5px solid #B71C1C;
      padding: 15px;
      border-radius: 8px;
      margin: 20px 0;
      text-align: center;
    }
	
	
  </style>
</head>
<body>
  <div class="container">
    <h1>‚öΩ Masaniello Dinamico</h1>
    <p class="subtitle">Sistema automatico di gestione bankroll - Versione Classica</p>

    <div id="setupSection" class="section">
      <h2 style="margin-bottom:20px;">üìù Configurazione Iniziale</h2>
      
      <div id="recuperoSessione" class="hidden" style="background:#d4edda;padding:15px;border-radius:8px;margin-bottom:20px;border-left:5px solid #28a745;">
        <strong>‚úÖ Sessione trovata!</strong>
        <p style="margin:10px 0;">Hai un piano Masaniello in corso.</p>
        <button class="btn" onclick="continuaSessione()" style="margin:5px;background:linear-gradient(135deg,#28a745,#20c997);">Continua Piano</button>
        <button class="btn" onclick="nuovoInizio()" style="margin:5px;background:#6c757d;">Ricomincia da Zero</button>
      </div>
      
      <div id="formConfig">
        <div class="input-group">
          <label for="bankroll">üí∞ Budget Iniziale (‚Ç¨)</label>
          <input type="number" id="bankroll" placeholder="Es: 100" step="0.01" min="1">
        </div>
        <div class="input-group">
          <label for="totEventi">üìä Numero Totale di Eventi</label>
          <input type="number" id="totEventi" placeholder="Es: 10" min="2" max="50">
        </div>
        <div class="input-group">
          <label for="eventiVincenti">‚úÖ Eventi Previsti Vincenti</label>
          <input type="number" id="eventiVincenti" placeholder="Es: 7" min="1">
        </div>
        <div class="input-group">
          <label for="quotaMedia">üìà Quota Media</label>
          <input type="number" id="quotaMedia" placeholder="Es: 1.80" step="0.01" min="1.01">
        </div>
        
        <div id="anteprima" class="hidden" style="background:#f0f8ff;padding:15px;border-radius:8px;margin-top:15px;border-left:4px solid #007bff;">
          <strong>üéØ Obiettivo Calcolato:</strong>
          <p style="margin:10px 0;font-size:1.1em;color:#007bff;">
            Cassa Finale: <strong id="obiettivoCassaCalcolato">‚Ç¨ 0.00</strong>
          </p>
          <small style="color:#666;">Profitto previsto: <span id="profittoPrevisto">‚Ç¨ 0.00</span> (<span id="roiPrevisto">0%</span>)</small>
        </div>
        
        <button class="btn" onclick="avviaMasaniello()">üöÄ Avvia Masaniello</button>
      </div>
    </div>

    <div id="gameSection" class="hidden">
      <div class="stats">
        <div class="stat-box">
          <div class="stat-label">Budget Attuale</div>
          <div class="stat-value" id="budgetAttuale">‚Ç¨ 0</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">Eventi Giocati</div>
          <div class="stat-value" id="eventiGiocati">0</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">Vittorie</div>
          <div class="stat-value" style="color:#38ef7d" id="vittorie">0</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">Sconfitte</div>
          <div class="stat-value" style="color:#f45c43" id="sconfitte">0</div>
        </div>
      </div>

      <div class="current-bet">
        <h2>Evento <span id="eventoCorrente">1</span></h2>
        
        <div class="quota-input-box">
          <label style="display:block;margin-bottom:8px;font-size:1em;">üìà Quota di questo evento:</label>
          <input type="number" id="quotaEvento" placeholder="Es: 1.85" step="0.01" min="1.01" 
                 style="width:100%;padding:10px;border:none;border-radius:6px;font-size:1.1em;text-align:center;">
        </div>
        
        <div class="bet-amount">‚Ç¨ <span id="puntataCorrente">0.00</span></div>
        <p style="margin-bottom:20px;">Vincita potenziale: ‚Ç¨ <span id="vincitaPotenziale">0.00</span></p>
        <div>
          <button class="btn btn-result btn-win" onclick="registraRisultato(true)">‚úÖ HO VINTO</button>
          <button class="btn btn-result btn-loss" onclick="registraRisultato(false)">‚ùå HO PERSO</button>
        </div>
      </div>

      <div class="warning" id="warningInfo"></div>

      <div class="section history">
        <h3 style="margin-bottom:15px;">üìú Storico Eventi</h3>
        <div id="historyList"></div>
      </div>

     <button class="btn" onclick="resetMasaniello()" style="background:#6c757d;margin-top:20px;">üîÑ Ricomincia da Capo</button>
    </div>

    <div style="text-align:center;margin-top:30px;padding-top:30px;border-top:2px solid #e0e0e0;color:#999;">
      <p>üìö di Gerardo D | <a href="https://beneinst.github.io/tradingspot/masaniello/guida.html" class="btn-green" target="_blank">Apri la Guida</a></p>
      
    </div>
  </div>
  
   <div id="finalSection" class="hidden"></div>
  </div>

  <script>
  let config = {};
let stato = {
  budgetCorrente: 0,
  eventiGiocati: 0,
  vittorie: 0,
  sconfitte: 0,
  storico: [],
  quotaEventoCorrente: 0
};

window.addEventListener('DOMContentLoaded', function() {
  verificaSessioneSalvata();
  
  // Listener per ricalcolo dinamico quando cambia la quota nel gioco
  const inputQuota = document.getElementById('quotaEvento');
  if (inputQuota) {
    inputQuota.addEventListener('input', function() {
      if (config.quotaMedia) {
        ricalcolaPuntata();
      }
    });
  }
  
  // Listener per calcolare anteprima obiettivo nella configurazione
  const campiConfig = ['bankroll', 'totEventi', 'eventiVincenti', 'quotaMedia'];
  campiConfig.forEach(campo => {
    const input = document.getElementById(campo);
    if (input) {
      input.addEventListener('input', calcolaAnteprimaObiettivo);
    }
  });
});

function verificaSessioneSalvata() {
  const datiSalvati = localStorage.getItem('masaniello_stato');
  if (datiSalvati) {
    document.getElementById('recuperoSessione').classList.remove('hidden');
    document.getElementById('formConfig').style.opacity = '0.5';
    document.getElementById('formConfig').style.pointerEvents = 'none';
  }
}

function continuaSessione() {
  caricaStatoSalvato();
}

function nuovoInizio() {
  cancellaStatoSalvato();
  document.getElementById('recuperoSessione').classList.add('hidden');
  document.getElementById('formConfig').style.opacity = '1';
  document.getElementById('formConfig').style.pointerEvents = 'auto';
}

function salvaStato() {
  const datiDaSalvare = {
    config: config,
    stato: stato,
    timestamp: new Date().toISOString()
  };
  localStorage.setItem('masaniello_stato', JSON.stringify(datiDaSalvare));
}

function caricaStatoSalvato() {
  const datiSalvati = localStorage.getItem('masaniello_stato');
  if (datiSalvati) {
    try {
      const dati = JSON.parse(datiSalvati);
      config = dati.config;
      stato = dati.stato;
      
      document.getElementById('setupSection').classList.add('hidden');
      document.getElementById('gameSection').classList.remove('hidden');
      aggiornaInterfaccia();
      
      const warningInfo = document.getElementById('warningInfo');
      const messaggioOriginale = warningInfo.innerHTML;
      warningInfo.innerHTML = '<strong>‚úÖ Sessione recuperata!</strong> Stai continuando il piano precedente. ' + messaggioOriginale;
    } catch (e) {
      console.error('Errore nel caricamento dello stato:', e);
    }
  }
}

function cancellaStatoSalvato() {
  localStorage.removeItem('masaniello_stato');
}

function comb(n, k) {
  if (k > n || k < 0) return 0;
  if (k === 0 || k === n) return 1;
  let res = 1;
  for (let i = 1; i <= k; i++) {
    res = res * (n - k + i) / i;
  }
  return res;
}

// CALCOLO REALISTICO DELL'OBIETTIVO CASSA - FORMULA CORRETTA
function calcolaObiettivoCassa(budgetIniziale, totEventi, eventiVincenti, quotaMedia) {
  // Formula realistica basata sul profitto atteso con distribuzione Masaniello
  // V = B √ó (1 + ((Q-1) √ó E) / N)
  // Dove:
  // B = Budget iniziale
  // Q = Quota media
  // E = Eventi vincenti previsti
  // N = Totale eventi
  
  const guadagnoPerEvento = (quotaMedia - 1) / totEventi;
  const fattoreMoltiplicativo = 1 + (guadagnoPerEvento * eventiVincenti);
  const cassaFinale = budgetIniziale * fattoreMoltiplicativo;
  
  return Math.round(cassaFinale * 100) / 100;
}

// ANTEPRIMA OBIETTIVO IN TEMPO REALE
function calcolaAnteprimaObiettivo() {
  const bankroll = parseFloat(document.getElementById('bankroll').value);
  const totEventi = parseInt(document.getElementById('totEventi').value);
  const eventiVincenti = parseInt(document.getElementById('eventiVincenti').value);
  const quotaMedia = parseFloat(document.getElementById('quotaMedia').value);
  
  const anteprima = document.getElementById('anteprima');
  
  if ([bankroll, totEventi, eventiVincenti, quotaMedia].some(v => isNaN(v))) {
    anteprima.classList.add('hidden');
    return;
  }
  
  if (eventiVincenti > totEventi || eventiVincenti < 1) {
    anteprima.classList.add('hidden');
    return;
  }
  
  const obiettivo = calcolaObiettivoCassa(bankroll, totEventi, eventiVincenti, quotaMedia);
  const profitto = obiettivo - bankroll;
  const roi = ((profitto / bankroll) * 100).toFixed(2);
  
  document.getElementById('obiettivoCassaCalcolato').textContent = '‚Ç¨ ' + obiettivo.toFixed(2);
  document.getElementById('profittoPrevisto').textContent = '‚Ç¨ ' + profitto.toFixed(2);
  document.getElementById('roiPrevisto').textContent = (roi > 0 ? '+' : '') + roi + '%';
  
  anteprima.classList.remove('hidden');
}

// FORMULA MASANIELLO CLASSICA CON TRIANGOLO DI TARTAGLIA
function calcolaPuntata(quotaReale) {
  const eventiRimasti = config.totEventi - stato.eventiGiocati;
  const vittorieRimaste = config.eventiVincenti - stato.vittorie;
  const sconfitteRimaste = eventiRimasti - vittorieRimaste;

  if (vittorieRimaste <= 0) return 0;
  if (sconfitteRimaste < 0) return 0;
  if (eventiRimasti <= 0) return 0;

  const B = stato.budgetCorrente;
  const V = config.obiettivoCassa;
  const Q = quotaReale || config.quotaMedia;
  const Qm = config.quotaMedia;
  const N = eventiRimasti;
  const E = vittorieRimaste;

  // Calcolo sommatoria con Triangolo di Tartaglia (coefficienti binomiali)
  let sommatoria = 0;
  
  for (let j = 0; j <= sconfitteRimaste; j++) {
    const C = comb(N - 1, j); // ‚Üê Triangolo di Tartaglia
    const termine = C * Math.pow(Qm - 1, j);
    sommatoria += termine;
  }

  if (sommatoria === 0 || sommatoria < 0.0001) {
    const puntataBase = B / eventiRimasti;
    console.warn('Sommatoria troppo piccola, uso distribuzione uniforme:', puntataBase);
    return Math.round(puntataBase * 100) / 100;
  }

  // Formula Masaniello: P = (V - B) / (Q √ó Qm^(E-1) √ó Sommatoria)
  const numeratore = V - B;
  const denominatore = Q * Math.pow(Qm, E - 1) * sommatoria;
  
  let puntata = numeratore / denominatore;

  // Se la puntata √® troppo bassa, applica minimo
  const puntataMinima = (B / eventiRimasti) * 0.8;
  
  if (puntata < puntataMinima) {
    puntata = puntataMinima;
  }

  // Limiti di sicurezza
  const minPuntata = 0.50;
  const maxPuntata = B * 0.99;
  
  puntata = Math.max(minPuntata, Math.min(puntata, maxPuntata));
  
  return Math.round(puntata * 100) / 100;
}

function ricalcolaPuntata() {
  const inputQuota = document.getElementById('quotaEvento');
  const quotaValue = inputQuota.value;
  
  const quotaReale = (quotaValue && !isNaN(parseFloat(quotaValue))) ? parseFloat(quotaValue) : config.quotaMedia;
  
  const puntata = calcolaPuntata(quotaReale);
  const vincita = puntata * quotaReale;
  document.getElementById('puntataCorrente').textContent = puntata.toFixed(2);
  document.getElementById('vincitaPotenziale').textContent = vincita.toFixed(2);
}

function avviaMasaniello() {
  const bankroll = parseFloat(document.getElementById('bankroll').value);
  const totEventi = parseInt(document.getElementById('totEventi').value);
  const eventiVincenti = parseInt(document.getElementById('eventiVincenti').value);
  const quotaMedia = parseFloat(document.getElementById('quotaMedia').value);

  if ([bankroll, totEventi, eventiVincenti, quotaMedia].some(v => isNaN(v))) {
    return alert('‚ö†Ô∏è Compila tutti i campi!');
  }

  if (eventiVincenti > totEventi) {
    return alert('‚ö†Ô∏è Gli eventi vincenti non possono superare il totale!');
  }

  if (eventiVincenti < 1) {
    return alert('‚ö†Ô∏è Devi prevedere almeno 1 evento vincente!');
  }

  // CALCOLO AUTOMATICO DELL'OBIETTIVO CON FORMULA CORRETTA
  const obiettivoCassa = calcolaObiettivoCassa(bankroll, totEventi, eventiVincenti, quotaMedia);

  config = {
    budgetIniziale: bankroll,
    totEventi: totEventi,
    eventiVincenti: eventiVincenti,
    quotaMedia: quotaMedia,
    obiettivoCassa: obiettivoCassa // ‚Üê Calcolato automaticamente in modo realistico
  };

  stato = {
    budgetCorrente: bankroll,
    eventiGiocati: 0,
    vittorie: 0,
    sconfitte: 0,
    storico: []
  };

  document.getElementById('setupSection').classList.add('hidden');
  document.getElementById('gameSection').classList.remove('hidden');
  
  salvaStato();
  aggiornaInterfaccia();
}

function aggiornaInterfaccia() {
  const inputQuota = document.getElementById('quotaEvento');
  
  if (!inputQuota.value) {
    inputQuota.value = config.quotaMedia.toFixed(2);
  }
  
  const quotaValue = inputQuota.value;
  const quotaReale = (quotaValue && !isNaN(parseFloat(quotaValue))) ? parseFloat(quotaValue) : config.quotaMedia;
  
  const puntata = calcolaPuntata(quotaReale);
  const vincita = puntata * quotaReale;

  document.getElementById('budgetAttuale').textContent = '‚Ç¨ ' + stato.budgetCorrente.toFixed(2);
  document.getElementById('eventiGiocati').textContent = stato.eventiGiocati + ' / ' + config.totEventi;
  document.getElementById('vittorie').textContent = stato.vittorie;
  document.getElementById('sconfitte').textContent = stato.sconfitte;
  document.getElementById('eventoCorrente').textContent = stato.eventiGiocati + 1;
  document.getElementById('puntataCorrente').textContent = puntata.toFixed(2);
  document.getElementById('vincitaPotenziale').textContent = vincita.toFixed(2);

  const sconfitteMax = config.totEventi - config.eventiVincenti;
  document.getElementById('warningInfo').innerHTML = `
    ‚ö†Ô∏è <strong>Attenzione:</strong> Puoi permetterti massimo <strong>${sconfitteMax - stato.sconfitte}</strong> 
    sconfitte rimanenti su <strong>${config.totEventi - stato.eventiGiocati}</strong> eventi rimasti.<br>
    üéØ <strong>Obiettivo:</strong> Raggiungere ‚Ç¨ ${config.obiettivoCassa.toFixed(2)} (mancano ‚Ç¨ ${(config.obiettivoCassa - stato.budgetCorrente).toFixed(2)})
  `;

  aggiornaStorico();
}

function aggiornaStorico() {
  const historyList = document.getElementById('historyList');
  if (stato.storico.length === 0) {
    historyList.innerHTML = '<p style="text-align:center;color:#999;">Nessun evento giocato ancora</p>';
    return;
  }

  historyList.innerHTML = stato.storico.map((item, idx) => `
    <div class="history-item ${item.vinto ? 'history-win' : 'history-loss'}">
      <div>
        <strong>Evento ${idx + 1}</strong><br>
        <small>Puntata: ‚Ç¨ ${item.puntata.toFixed(2)} | Quota: ${item.quota ? item.quota.toFixed(2) : config.quotaMedia.toFixed(2)}</small>
      </div>
      <div>
        <span class="badge ${item.vinto ? 'badge-win' : 'badge-loss'}">
          ${item.vinto ? '‚úÖ VINTO' : '‚ùå PERSO'}
        </span><br>
        <small style="color:#666;">Budget: ‚Ç¨ ${item.budgetDopo.toFixed(2)}</small>
      </div>
    </div>
  `).reverse().join('');
}

function registraRisultato(vinto) {
  const inputQuota = document.getElementById('quotaEvento');
  const quotaReale = parseFloat(inputQuota.value);
  
  if (!quotaReale || quotaReale < 1.01 || isNaN(quotaReale)) {
    alert('‚ö†Ô∏è Inserisci una quota valida per questo evento (minimo 1.01)!');
    inputQuota.focus();
    return;
  }
  
  const puntata = calcolaPuntata(quotaReale);

  if (vinto) {
    const vincitaNetta = puntata * quotaReale - puntata;
    stato.budgetCorrente += vincitaNetta;
    stato.vittorie++;
  } else {
    stato.budgetCorrente -= puntata;
    stato.sconfitte++;
  }

  stato.storico.push({
    vinto: vinto,
    puntata: puntata,
    quota: quotaReale,
    budgetDopo: stato.budgetCorrente
  });

  stato.eventiGiocati++;

  salvaStato();
  verificaFineProgramma();
}

function verificaFineProgramma() {
  const sconfitteMax = config.totEventi - config.eventiVincenti;

  if (stato.eventiGiocati >= config.totEventi) {
    mostraRisultatoFinale('completato');
    return;
  }

  if (stato.vittorie >= config.eventiVincenti) {
    mostraRisultatoFinale('successo');
    return;
  }

  if (stato.sconfitte > sconfitteMax) {
    mostraRisultatoFinale('fallito');
    return;
  }

  if (stato.budgetCorrente <= 0.01) {
    mostraRisultatoFinale('bankroll_esaurito');
    return;
  }

  const inputQuota = document.getElementById('quotaEvento');
  inputQuota.value = config.quotaMedia.toFixed(2);
  inputQuota.focus();
  
  aggiornaInterfaccia();
}

function mostraRisultatoFinale(tipo) {
  document.getElementById('gameSection').classList.add('hidden');
  const finalSection = document.getElementById('finalSection');
  finalSection.classList.remove('hidden');

  cancellaStatoSalvato();

  const profitto = stato.budgetCorrente - config.budgetIniziale;
  const roi = ((profitto / config.budgetIniziale) * 100).toFixed(2);
  const differenzaObiettivo = stato.budgetCorrente - config.obiettivoCassa;

  let messaggio = '';
  let classe = '';

  if (tipo === 'successo') {
    messaggio = `
      <h2>üéâ OBIETTIVO RAGGIUNTO!</h2>
      <p style="font-size:1.2em;margin:15px 0;">Hai vinto ${config.eventiVincenti} eventi come previsto!</p>
      <p><strong>Budget Finale:</strong> ‚Ç¨ ${stato.budgetCorrente.toFixed(2)}</p>
      <p><strong>Obiettivo:</strong> ‚Ç¨ ${config.obiettivoCassa.toFixed(2)}</p>
      <p><strong>Differenza:</strong> ‚Ç¨ ${differenzaObiettivo.toFixed(2)}</p>
      <p><strong>Profitto Totale:</strong> ‚Ç¨ ${profitto.toFixed(2)} (${roi > 0 ? '+' : ''}${roi}%)</p>
    `;
    classe = 'success';
  } else if (tipo === 'fallito') {
    messaggio = `
      <h2>‚ùå PIANO FALLITO</h2>
      <p style="font-size:1.2em;margin:15px 0;">Hai superato il numero massimo di sconfitte consentite.</p>
      <p><strong>Budget Finale:</strong> ‚Ç¨ ${stato.budgetCorrente.toFixed(2)}</p>
      <p><strong>Perdita:</strong> ‚Ç¨ ${Math.abs(profitto).toFixed(2)} (${roi}%)</p>
    `;
    classe = 'danger';
  } else if (tipo === 'bankroll_esaurito') {
    messaggio = `
      <h2>üí∏ BANKROLL ESAURITO</h2>
      <p style="font-size:1.2em;margin:15px 0;">Il budget √® terminato prima del completamento del piano.</p>
      <p><strong>Eventi Completati:</strong> ${stato.eventiGiocati} / ${config.totEventi}</p>
    `;
    classe = 'danger';
  } else {
    messaggio = `
      <h2>üèÅ PIANO COMPLETATO</h2>
      <p style="font-size:1.2em;margin:15px 0;">Hai completato tutti gli eventi previsti.</p>
      <p><strong>Budget Finale:</strong> ‚Ç¨ ${stato.budgetCorrente.toFixed(2)}</p>
      <p><strong>Obiettivo:</strong> ‚Ç¨ ${config.obiettivoCassa.toFixed(2)}</p>
      <p><strong>Differenza:</strong> ‚Ç¨ ${differenzaObiettivo.toFixed(2)}</p>
      <p><strong>Risultato:</strong> ‚Ç¨ ${profitto.toFixed(2)} (${roi > 0 ? '+' : ''}${roi}%)</p>
    `;
    classe = profitto > 0 ? 'success' : 'danger';
  }

  finalSection.innerHTML = `
    <div class="${classe}">
      ${messaggio}
      <div style="margin-top:20px;">
        <strong>Riepilogo:</strong><br>
        Vittorie: ${stato.vittorie} | Sconfitte: ${stato.sconfitte}<br>
        Somma puntate: ‚Ç¨ ${stato.storico.reduce((sum, item) => sum + item.puntata, 0).toFixed(2)}
      </div>
    </div>
    <button class="btn" onclick="resetMasaniello()" style="margin-top:20px;">üîÑ Nuovo Masaniello</button>
  `;
}

function resetMasaniello() {
  document.getElementById('setupSection').classList.remove('hidden');
  document.getElementById('gameSection').classList.add('hidden');
  document.getElementById('finalSection').classList.add('hidden');
  
  cancellaStatoSalvato();
  
  document.getElementById('finalSection').innerHTML = '';
}
  </script>
</body>
</html>