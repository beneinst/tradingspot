<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ChartFlow</title>
   
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="icon" type="image/png" href="https://beneinst.github.io/tradingspot/favicon.png">
  <!-- Libreria Lightweight Charts da CDN -->
  <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <!-- File JavaScript per gli indicatori tecnici -->
  <script src="indicators.js"></script>
  <!-- File JavaScript per gli strumenti di disegno -->
  <script src="drawing-tools.js"></script>
  <style>
  /* Stili Globali per tutti i dispositivi (desktop first approach, o base) */
  html, body {
    height: 100%;
    margin: 0;
    padding: 0;
    font-family: 'Trebuchet MS', sans-serif;
    font-size: 14px;
    background: linear-gradient(to bottom, #000000 0%, #050505 50%, #131722 100%);
    overflow-x: hidden; /* Previene lo scroll orizzontale */
  }

  #page-title {
    color: #fff;
    margin: 0;
    padding: 16px 24px 0 24px;
    font-size: 1.2em;
    letter-spacing: 1px;
  }

  #topbar {
    width: 100%;
    background: #23272f;
    padding: 12px 18px;
    display: flex;
    gap: 20px;
    align-items: center;
    justify-content: space-between;
    border-bottom: 1.5px solid #222;
    box-sizing: border-box;
    z-index: 10;
    flex-wrap: wrap; /* Permette agli elementi di andare a capo su schermi piccoli */
  }

  #app-title {
    color: #fff;
    margin: 0;
    font-size: 1.1em;
    letter-spacing: 1px;
    white-space: nowrap; /* Mantiene il titolo su una riga se possibile */
  }

  #toolbar-buttons {
    display: flex;
    gap: 8px;
    align-items: center;
  }

  #toolbar-buttons button {
    padding: 8px 12px;
    font-size: 1.2em;
    border-radius: 4px;
    border: 1px solid #444;
    background: #20232a;
    color: #fff;
    cursor: pointer;
    transition: all 0.2s ease;
    min-width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  #toolbar-buttons button:hover {
    border-color: #26a69a;
    background: #26a69a;
    transform: translateY(-1px);
  }

  #toolbar-buttons button:active {
    transform: translateY(0);
  }

  .left-section {
    display: flex;
    gap: 20px;
    align-items: center;
    flex: 1; /* Permette alla sezione di espandersi */
    min-width: 0; /* Importante per i flex items per non traboccare */
  }

  .center-section {
    display: flex;
    gap: 15px;
    align-items: center;
  }

  .right-section {
    display: flex;
    gap: 10px;
    align-items: center;
  }

  #symbol-select {
    padding: 8px 12px;
    font-size: 1rem;
    border-radius: 4px;
    border: 1px solid #444;
    background: #20232a;
    color: #fff;
    cursor: pointer;
    min-width: 150px; /* Larghezza minima per desktop */
    flex-grow: 1; /* Permette di espandersi nel flex container */
  }

  #symbol-select:hover {
    border-color: #666;
  }

  #symbol-select:focus {
    outline: none;
    border-color: #26a69a;
  }

  #current-price {
    color: #26a69a;
    font-weight: bold;
    font-size: 1.1em;
    white-space: nowrap; /* Evita che il prezzo si rompa su pi√π righe */
  }

  #chart {
    /* Larghezza al 100% del suo contenitore, non della viewport */
    /* L'altezza deve tenere conto della topbar, che ora potrebbe avvolgersi su pi√π righe */
    width: 100%; 
    height: calc(100vh - var(--topbar-height, 64px)); /* Placeholder per l'altezza della topbar */
    /* Verr√† regolata in JS in base all'altezza dinamica della topbar */
  }

  .loading {
    color: #fff;
    text-align: center;
    padding: 20px;
  }

  .price-change {
    font-size: 0.9em;
    margin-left: 10px;
    white-space: nowrap; /* Evita che la variazione di prezzo si rompa */
  }

  .price-up {
    color: #26a69a;
  }

  .price-down {
    color: #ef5350;
  }

  /* MEDIA QUERY per dispositivi con larghezza massima di 480px */
  @media (max-width: 480px) {
    #page-title {
      font-size: 1em; /* Riduci la dimensione del font per il titolo principale */
      padding: 12px 16px 0 16px; /* Riduci il padding */
    }

    #topbar {
      flex-direction: column; /* Impila gli elementi verticalmente */
      align-items: flex-start; /* Allinea a sinistra quando impilati */
      padding: 10px 15px; /* Riduci il padding della topbar */
      gap: 10px; /* Riduci lo spazio tra gli elementi */
	  font-size: 14px;
    }

    #app-title {
      font-size: 1em; /* Riduci la dimensione del font del titolo app */
      width: 100%; /* Occupa tutta la larghezza disponibile */
      text-align: center; /* Centra il titolo */
    }

    .left-section,
    .center-section,
    .right-section {
      flex-direction: column; /* Impila le sezioni interne verticalmente */
      width: 100%; /* Le sezioni interne occupano tutta la larghezza */
      align-items: center; /* Centra gli elementi all'interno delle sezioni */
      gap: 5px; /* Riduci lo spazio tra gli elementi */
    }
    
    #toolbar-buttons {
      width: 100%;
      justify-content: space-around; /* Distribuisci i bottoni orizzontalmente */
      gap: 5px; /* Riduci il gap */
    }

    #toolbar-buttons button {
      min-width: unset; /* Rimuovi la larghezza minima fissa */
      flex-grow: 1; /* Permetti ai bottoni di espandersi */
      font-size: 1em; /* Riduci dimensione font bottoni */
      padding: 6px 8px; /* Riduci padding bottoni */
      height: 36px; /* Riduci l'altezza dei bottoni */
    }

    #symbol-select {
      min-width: 100%; /* Occupa tutta la larghezza disponibile */
      font-size: 0.9em; /* Riduci la dimensione del font del selettore */
    }

    #current-price,
    .price-change {
      font-size: 1em; /* Adatta la dimensione del font per i prezzi */
      margin-left: 0; /* Rimuovi il margine a sinistra */
    }

    #chart {
      /* Su mobile, l'altezza della topbar potrebbe variare di pi√π */
      /* √à consigliabile calcolare dinamicamente l'altezza della topbar in JavaScript */
      /* per un'esperienza pi√π robusta. Per ora, un'altezza fissa o vw */
      height: calc(100vh - 120px); /* Regola questa altezza in base a quanto occupa la topbar su mobile */
    }
  }
  	 .footer {
            margin-top: 30px;
            margin-bottom: 10px;
            text-align: center;
            font-size: 16px;
            color: #f2bb66;
            font-weight: normal;
        }

        .footer a {
            color: #ffe;
            text-decoration: none;
            margin: 0 8px;
            transition: color 0.3s ease;
        }

        .footer a:hover {
            color: #ffdb58;
        }
</style>
</head>
<body>
  <!-- Barra superiore -->
  <div id="topbar">
    <div class="left-section">
      <h4 id="app-title">üìä 4H StratMC</h4>
      <select id="symbol-select">
        <option value="">Seleziona Asset...</option>
      </select>
    </div>
    <div class="center-section">
      <span id="current-price"></span>
      <span id="price-change" class="price-change"></span>
    </div>
    <div class="right-section">
      <div id="toolbar-buttons">
	  <button id="dashboard-btn" title="Apri Dashboard">üìã</button>

        <button id="drawing-tools-btn" title="Strumenti di Disegno">‚úèÔ∏è</button>
        <button id="indicators-btn" title="Gestisci Indicatori">üìà</button>
        <button id="screenshot-btn" title="Salva Screenshot">üì∏</button>
        <button id="fullscreen-btn" title="Schermo Intero">‚õ∂</button>
        <button id="refresh-btn" title="Aggiorna Dati">üîÑ</button>
      </div>
    </div>
  </div>
  <div id="chart"></div>
   <div class="footer">
        Trading Spot Manager v1.1 | 
        <a href="index.html">Operativit√†</a> | 
        <a href="panoramica-capitale.html">Capitale</a> | 
        <a href="blocco-note.html">Note</a> | 
		<a href="https://beneinst.github.io/tradingspot/chartflow/index.html">Segnali</a> |
		<a href="Strategia-Trading.html">Indicatore</a> | 
        <a href="regole-trading.html">Regole</a> |
		<a href="candlestick.html">Candlestick</a> | 
        <a href="cheat-sheet.html">Patterns</a>
         </div>


<script>
window.addEventListener('DOMContentLoaded', function() {
  const watchlistSymbols = [
    'BTCUSDC','ETHUSDC','SOLEUR','FETUSDC','DOTUSDC','LTCUSDC','BNBUSDC','ADAUSDC',
    'FILUSDC','AVAXUSDC','MANAUSDC','SUIUSDC','ALGOUSDT','NEARUSDC','LINKUSDC',
    'UNIUSDC','BELUSDC','SLFUSDC','APEUSDC','DOGEUSDC','ATOMUSDC'
  ];
  const symbolSelect = document.getElementById('symbol-select');
  const currentPriceEl = document.getElementById('current-price');
  const priceChangeEl = document.getElementById('price-change');
  let selectedSymbol = watchlistSymbols[0];
  let chart, candleSeries, lastPrice = 0;

  // Popola il menu a tendina
  watchlistSymbols.forEach(symbol => {
    const option = document.createElement('option');
    option.value = symbol;
    option.textContent = symbol;
    symbolSelect.appendChild(option);
  });
  symbolSelect.value = selectedSymbol;

  // Event listener per il cambio di simbolo
  symbolSelect.addEventListener('change', function() {
    const newSymbol = this.value;
    if (newSymbol && newSymbol !== selectedSymbol) {
      selectedSymbol = newSymbol;
      loadBinanceData(selectedSymbol);
      getCurrentPrice(selectedSymbol);
    }
  });

  // Funzione per ottenere il prezzo corrente
  function getCurrentPrice(symbol) {
    fetch(`https://api.binance.com/api/v3/ticker/24hr?symbol=${symbol}`)
      .then(response => response.json())
      .then(data => {
        const price = parseFloat(data.lastPrice);
        const change = parseFloat(data.priceChangePercent);
        currentPriceEl.textContent = `$${price.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 6})}`;
        priceChangeEl.textContent = `${change >= 0 ? '+' : ''}${change.toFixed(2)}%`;
        priceChangeEl.className = `price-change ${change >= 0 ? 'price-up' : 'price-down'}`;
        lastPrice = price;
      })
      .catch(err => console.error('Errore caricamento prezzo:', err));
  }

  // Funzione per caricare i dati da Binance
  function loadBinanceData(symbol) {
    currentPriceEl.textContent = 'Caricamento...';
    priceChangeEl.textContent = '';
    fetch(`https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=4h&limit=100`)
      .then(response => response.json())
      .then(data => {
        const formatted = data.map(c => ({
          time: Math.floor(c[0] / 1000),
          open: parseFloat(c[1]),
          high: parseFloat(c[2]),
          low: parseFloat(c[3]),
          close: parseFloat(c[4]),
        }));
        candleSeries.setData(formatted);
        // Aggiorna gli indicatori SOLO tramite indicators.js
        if (window.TechnicalIndicators && chart && candleSeries) {
          window.TechnicalIndicators.updateIndicators(chart, candleSeries, formatted);
        }
      })
      .catch(err => {
        console.error('Errore caricamento dati Binance:', err);
        currentPriceEl.textContent = 'Errore caricamento';
      });
  }

  // Inizializza il grafico
  function initChart() {
    const chartContainer = document.getElementById('chart');
    chart = LightweightCharts.createChart(chartContainer, {
      width: chartContainer.clientWidth,
      height: chartContainer.clientHeight,
      layout: { background: { color: '#181a20' }, textColor: '#d1d4dc' },
      grid: { vertLines: { color: '#222' }, horzLines: { color: '#222' } },
      timeScale: { timeVisible: true, secondsVisible: false },
      rightPriceScale: { borderColor: '#444' },
      crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
    });

    candleSeries = chart.addSeries(LightweightCharts.CandlestickSeries, {
    upColor: '#26a69a',
    downColor: '#ef5350',
    borderVisible: false,
    wickUpColor: '#26a69a',
    wickDownColor: '#ef5350',
  });

    window.addEventListener('resize', () => {
      chart.applyOptions({
        width: chartContainer.clientWidth,
        height: chartContainer.clientHeight
      });
    });
  }

  // Toolbar: strumenti di disegno
  document.getElementById('drawing-tools-btn').addEventListener('click', function() {
    if (typeof window.DrawingTools !== 'undefined') {
      window.DrawingTools.openPanel(chart, candleSeries);
    } else {
      loadDrawingToolsScript();
    }
  });

  function loadDrawingToolsScript() {
    const script = document.createElement('script');
    script.src = 'drawing-tools.js';
    script.onload = function() {
      if (typeof window.DrawingTools !== 'undefined') {
        window.DrawingTools.openPanel(chart, candleSeries);
      }
    };
    script.onerror = function() {
      alert('Errore: impossibile caricare drawing-tools.js');
    };
    document.head.appendChild(script);
  }

  // Toolbar: indicatori
  document.getElementById('indicators-btn').addEventListener('click', function() {
    if (typeof window.TechnicalIndicators !== 'undefined') {
      window.TechnicalIndicators.openPanel(chart, candleSeries);
    } else {
      loadIndicatorsScript();
    }
  });

  function loadIndicatorsScript() {
    const script = document.createElement('script');
    script.src = 'indicators.js';
    script.onload = function() {
      if (typeof window.TechnicalIndicators !== 'undefined') {
        window.TechnicalIndicators.openPanel(chart, candleSeries);
      }
    };
    script.onerror = function() {
      alert('Errore: impossibile caricare indicators.js');
    };
    document.head.appendChild(script);
  }

  // Toolbar: dashboard
  document.getElementById('dashboard-btn').addEventListener('click', function() {
    window.open('index.html', '_blank');
  });

  // Toolbar: screenshot
  document.getElementById('screenshot-btn').addEventListener('click', function() {
    html2canvas(document.getElementById('chart')).then(canvas => {
      const link = document.createElement('a');
      link.download = `${selectedSymbol}_chart_${new Date().getTime()}.png`;
      link.href = canvas.toDataURL();
      link.click();
    });
  });

  // Toolbar: fullscreen
  document.getElementById('fullscreen-btn').addEventListener('click', function() {
    if (!document.fullscreenElement) {
      document.documentElement.requestFullscreen().catch(err => {
        console.log('Errore fullscreen:', err);
      });
    } else {
      document.exitFullscreen();
    }
  });

  // Toolbar: refresh
  document.getElementById('refresh-btn').addEventListener('click', function() {
    if (selectedSymbol) {
      loadBinanceData(selectedSymbol);
      getCurrentPrice(selectedSymbol);
    }
  });

  // Inizializzazione
  initChart();
  loadBinanceData(selectedSymbol);
  getCurrentPrice(selectedSymbol);

  // Aggiorna il prezzo ogni 10 secondi
  setInterval(() => {
    if (selectedSymbol) {
      getCurrentPrice(selectedSymbol);
    }
  }, 10000);

});
</script>

</body>
</html>