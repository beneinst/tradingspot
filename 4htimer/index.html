<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Trading - Timer Indicator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            color: white;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .control-group {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .file-input {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-button {
            display: block;
            width: 100%;
            padding: 15px;
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            text-align: center;
            transition: all 0.3s ease;
        }

        .file-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
        }

        .button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .btn-primary {
            background: linear-gradient(45deg, #2196F3, #1976D2);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(45deg, #f44336, #d32f2f);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(45deg, #ff9800, #f57c00);
            color: white;
        }

        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .panel {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        .panel h3 {
            margin-bottom: 15px;
            color: #ffd700;
            border-bottom: 2px solid #ffd700;
            padding-bottom: 5px;
        }

        .indicators {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .indicator {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #ffd700;
        }

        .indicator-label {
            font-size: 12px;
            opacity: 0.8;
            margin-bottom: 5px;
        }

        .indicator-value {
            font-size: 18px;
            font-weight: bold;
        }

        .timer-section {
            grid-column: 1 / -1;
            margin-top: 20px;
        }

        .timer-display {
            background: linear-gradient(45deg, #ff6b35, #f7931e);
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 20px;
        }

        .timer-counter {
            font-size: 3em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .timer-status {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .signals-history {
            max-height: 400px;
            overflow-y: auto;
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            padding: 15px;
        }

        .signal-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 8px;
            background: rgba(255,255,255,0.1);
        }

        .signal-bull { border-left: 4px solid #4CAF50; }
        .signal-bear { border-left: 4px solid #f44336; }
        .signal-neutral { border-left: 4px solid #ffd700; }

        .status {
            padding: 20px;
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .status.error {
            background: rgba(244, 67, 54, 0.3);
            border: 1px solid #f44336;
        }

        .status.success {
            background: rgba(76, 175, 80, 0.3);
            border: 1px solid #4CAF50;
        }

        .json-format {
            background: rgba(0,0,0,0.5);
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
            margin-top: 10px;
            border: 1px solid #555;
        }

        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .controls {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ Trading Dashboard</h1>
            <p>Timer Indicator & Analisi Multi-Confluenza</p>
        </div>

        <div class="controls">
            <div class="control-group">
                <h3>üìÅ Carica Dati</h3>
                <div class="file-input-wrapper">
                    <input type="file" id="jsonFile" class="file-input" accept=".json" />
                    <label for="jsonFile" class="file-button">
                        üì§ Seleziona File JSON
                    </label>
                </div>
                <div style="margin-top: 10px;">
                    <button class="button btn-primary" onclick="processData()">üîÑ Elabora Dati</button>
                    <button class="button btn-danger" onclick="clearData()">üóëÔ∏è Reset</button>
                </div>
            </div>

            <div class="control-group">
                <h3>‚öôÔ∏è Configurazioni Timer</h3>
                <label>Max Candele Timer: <input type="number" id="maxCandles" value="12" min="1" max="50" /></label><br><br>
                <label>Soglia Segnale: <input type="number" id="signalThreshold" value="0.5" step="0.1" min="-1" max="1" /></label><br><br>
                <button class="button btn-warning" onclick="updateConfig()">üíæ Aggiorna Config</button>
            </div>
        </div>

        <div id="status" class="status" style="display: none;"></div>

        <div class="dashboard">
            <div class="panel">
                <h3>üìä Indicatori Attuali</h3>
                <div class="indicators" id="indicators">
                    <!-- Indicatori dinamici -->
                </div>
            </div>

            <div class="panel">
                <h3>üìà Stato Mercato</h3>
                <div id="marketInfo">
                    <div class="indicator">
                        <div class="indicator-label">Prezzo Attuale</div>
                        <div class="indicator-value" id="currentPrice">--</div>
                    </div>
                    <div class="indicator">
                        <div class="indicator-label">Candele Caricate</div>
                        <div class="indicator-value" id="candleCount">0</div>
                    </div>
                    <div class="indicator">
                        <div class="indicator-label">Ultimo Aggiornamento</div>
                        <div class="indicator-value" id="lastUpdate">--</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="timer-section">
            <div class="panel">
                <h3>‚è±Ô∏è Timer Indicator</h3>
                <div class="timer-display">
                    <div class="timer-counter" id="timerCounter">0/12</div>
                    <div class="timer-status" id="timerStatus">In Attesa Segnale</div>
                </div>
                
                <div class="signals-history">
                    <h4>üéØ Storico Segnali</h4>
                    <div id="signalsContainer">
                        <!-- Segnali storici -->
                    </div>
                </div>
            </div>
        </div>

        <div class="panel">
            <h3>üìã Formato File JSON Richiesto</h3>
            <div class="json-format">
{<br>
  &nbsp;&nbsp;"data": [<br>
  &nbsp;&nbsp;&nbsp;&nbsp;{<br>
  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"timestamp": 1640995200000,<br>
  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"open": 47000.50,<br>
  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"high": 47500.25,<br>
  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"low": 46800.75,<br>
  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"close": 47200.00<br>
  &nbsp;&nbsp;&nbsp;&nbsp;},<br>
  &nbsp;&nbsp;&nbsp;&nbsp;...<br>
  &nbsp;&nbsp;]<br>
}<br><br>
<strong>Per scaricare dati:</strong><br>
‚Ä¢ CoinGecko: /coins/{id}/ohlc?vs_currency=usd&days=30<br>
‚Ä¢ Binance: /api/v3/klines?symbol=BTCUSDT&interval=4h&limit=500<br>
‚Ä¢ File manuale con timeframe 4H
            </div>
        </div>
    </div>

    <script type="module">
        // Configurazioni Timer
        let timerConfig = {
            maxCandles: 12,
            signalThreshold: 0.5,
            currentCount: 0,
            isActive: false,
            signals: []
        };

        let marketData = [];
        let indicators = {};

        // Simulazione logica.js (sostituire con import reale)
        const TradingLogic = {
            processNewCandle: (candle, symbol = 'btcusdt') => {
                // Simulazione - da sostituire con la vostra logica reale
                return {
                    timestamp: candle.timestamp,
                    linreg: (Math.random() * 2 - 1).toFixed(4),
                    pearson: (Math.random() * 2 - 1).toFixed(4),
                    bb: (Math.random() * 2 - 1).toFixed(4),
                    stochK: (Math.random() * 100).toFixed(2),
                    stochD: (Math.random() * 100).toFixed(2),
                    rsi: (20 + Math.random() * 60).toFixed(2),
                    ema: (candle.close * (0.98 + Math.random() * 0.04)).toFixed(2),
                    sma: (candle.close * (0.97 + Math.random() * 0.06)).toFixed(2),
                    score: (Math.random() * 2 - 1).toFixed(4),
                    candles: marketData.length
                };
            }
        };

        // Gestione file
        document.getElementById('jsonFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                updateStatus(`File selezionato: ${file.name} (${(file.size/1024).toFixed(1)}KB)`, 'success');
            }
        });

        function processData() {
            const fileInput = document.getElementById('jsonFile');
            const file = fileInput.files[0];
            
            if (!file) {
                updateStatus('Seleziona prima un file JSON', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const jsonData = JSON.parse(e.target.result);
                    
                    if (!jsonData.data || !Array.isArray(jsonData.data)) {
                        throw new Error('Formato JSON non valido. Richiesto: {data: [...]}');
                    }

                    marketData = jsonData.data;
                    updateStatus(`‚úÖ Caricati ${marketData.length} candele`, 'success');
                    
                    calculateIndicators();
                    processTimerLogic();
                    updateUI();
                    
                } catch (error) {
                    updateStatus(`‚ùå Errore: ${error.message}`, 'error');
                }
            };
            reader.readAsText(file);
        }

        function calculateIndicators() {
            if (marketData.length === 0) return;
            
            const lastCandle = marketData[marketData.length - 1];
            indicators = TradingLogic.processNewCandle(lastCandle);
            
            console.log('Indicatori calcolati:', indicators);
        }

        function processTimerLogic() {
            if (marketData.length === 0) return;

            marketData.forEach((candle, index) => {
                const result = TradingLogic.processNewCandle(candle);
                const signal = detectSignal(result);
                
                if (signal !== 'neutral') {
                    handleNewSignal(signal, candle, index);
                } else {
                    updateTimerCount();
                }
            });
        }

        function detectSignal(result) {
            const score = parseFloat(result.score);
            if (score > timerConfig.signalThreshold) return 'bull';
            if (score < -timerConfig.signalThreshold) return 'bear';
            return 'neutral';
        }

        function handleNewSignal(signal, candle, index) {
            // Reset timer se nuovo segnale
            timerConfig.currentCount = 1;
            timerConfig.isActive = true;
            
            const signalData = {
                type: signal,
                timestamp: candle.timestamp,
                price: candle.close,
                candle: index + 1,
                startCount: 1,
                completed: false
            };
            
            timerConfig.signals.push(signalData);
            console.log(`üéØ Nuovo segnale ${signal.toUpperCase()} rilevato`, signalData);
        }

        function updateTimerCount() {
            if (timerConfig.isActive && timerConfig.currentCount < timerConfig.maxCandles) {
                timerConfig.currentCount++;
                
                if (timerConfig.currentCount >= timerConfig.maxCandles) {
                    // Timer completato
                    timerConfig.isActive = false;
                    if (timerConfig.signals.length > 0) {
                        timerConfig.signals[timerConfig.signals.length - 1].completed = true;
                    }
                    console.log('‚è∞ Timer completato - In attesa nuovo segnale');
                }
            }
        }

        function updateUI() {
            // Aggiorna indicatori
            updateIndicatorsDisplay();
            
            // Aggiorna info mercato
            updateMarketInfo();
            
            // Aggiorna timer
            updateTimerDisplay();
            
            // Aggiorna storico segnali
            updateSignalsHistory();
        }

        function updateIndicatorsDisplay() {
            if (!indicators) return;
            
            const container = document.getElementById('indicators');
            container.innerHTML = `
                <div class="indicator">
                    <div class="indicator-label">BB Position</div>
                    <div class="indicator-value">${indicators.bb}</div>
                </div>
                <div class="indicator">
                    <div class="indicator-label">StochRSI K</div>
                    <div class="indicator-value">${indicators.stochK}%</div>
                </div>
                <div class="indicator">
                    <div class="indicator-label">StochRSI D</div>
                    <div class="indicator-value">${indicators.stochD}%</div>
                </div>
                <div class="indicator">
                    <div class="indicator-label">RSI</div>
                    <div class="indicator-value">${indicators.rsi}</div>
                </div>
                <div class="indicator">
                    <div class="indicator-label">Score</div>
                    <div class="indicator-value" style="color: ${parseFloat(indicators.score) > 0 ? '#4CAF50' : '#f44336'}">${indicators.score}</div>
                </div>
                <div class="indicator">
                    <div class="indicator-label">Pearson</div>
                    <div class="indicator-value">${indicators.pearson}</div>
                </div>
            `;
        }

        function updateMarketInfo() {
            if (marketData.length === 0) return;
            
            const lastCandle = marketData[marketData.length - 1];
            document.getElementById('currentPrice').textContent = `$${lastCandle.close.toLocaleString()}`;
            document.getElementById('candleCount').textContent = marketData.length;
            document.getElementById('lastUpdate').textContent = new Date(lastCandle.timestamp).toLocaleString();
        }

        function updateTimerDisplay() {
            const counter = document.getElementById('timerCounter');
            const status = document.getElementById('timerStatus');
            
            counter.textContent = `${timerConfig.currentCount}/${timerConfig.maxCandles}`;
            
            if (timerConfig.isActive) {
                status.textContent = `Timer Attivo - ${timerConfig.maxCandles - timerConfig.currentCount} candele rimanenti`;
                counter.style.color = '#ff6b35';
            } else {
                status.textContent = 'In Attesa Nuovo Segnale';
                counter.style.color = '#ffd700';
            }
        }

        function updateSignalsHistory() {
            const container = document.getElementById('signalsContainer');
            
            if (timerConfig.signals.length === 0) {
                container.innerHTML = '<p style="opacity: 0.6;">Nessun segnale rilevato</p>';
                return;
            }
            
            const signalsHtml = timerConfig.signals.slice(-10).reverse().map(signal => `
                <div class="signal-item signal-${signal.type}">
                    <div>
                        <strong>${signal.type.toUpperCase()}</strong> - Candela #${signal.candle}<br>
                        <small>${new Date(signal.timestamp).toLocaleString()}</small>
                    </div>
                    <div>
                        <div>$${signal.price.toLocaleString()}</div>
                        <small>${signal.completed ? '‚úÖ Completato' : '‚è≥ In corso'}</small>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = signalsHtml;
        }

        function updateStatus(message, type = 'info') {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
            statusEl.style.display = 'block';
            
            setTimeout(() => {
                statusEl.style.display = 'none';
            }, 5000);
        }

        function updateConfig() {
            timerConfig.maxCandles = parseInt(document.getElementById('maxCandles').value);
            timerConfig.signalThreshold = parseFloat(document.getElementById('signalThreshold').value);
            
            updateStatus('‚öôÔ∏è Configurazione aggiornata', 'success');
            
            if (marketData.length > 0) {
                processTimerLogic();
                updateUI();
            }
        }

        function clearData() {
            marketData = [];
            indicators = {};
            timerConfig.signals = [];
            timerConfig.currentCount = 0;
            timerConfig.isActive = false;
            
            document.getElementById('jsonFile').value = '';
            document.getElementById('indicators').innerHTML = '';
            document.getElementById('signalsContainer').innerHTML = '';
            document.getElementById('currentPrice').textContent = '--';
            document.getElementById('candleCount').textContent = '0';
            document.getElementById('lastUpdate').textContent = '--';
            
            updateTimerDisplay();
            updateStatus('üóëÔ∏è Dati cancellati', 'success');
        }

        // Rendi funzioni globali
        window.processData = processData;
        window.clearData = clearData;
        window.updateConfig = updateConfig;

        // Inizializzazione
        updateTimerDisplay();
        updateStatus('üí° Carica un file JSON per iniziare', 'info');
    </script>
</body>
</html>