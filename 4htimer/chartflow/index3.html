<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Dashboard - Indicatori Pine Script</title>
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }
        
        .symbol-selector {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        select {
            padding: 12px 16px;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
        }
        
        .price-info {
            text-align: right;
        }
        
        .current-price {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .price-change {
            font-size: 1.2em;
            font-weight: 600;
        }
        
        .price-up { color: #4CAF50; }
        .price-down { color: #f44336; }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 20px;
        }
        
        .chart-container {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
        }
        
        .indicators-panel {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            max-height: 600px;
            overflow-y: auto;
        }
        
        .indicator-section {
            margin-bottom: 25px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }
        
        .indicator-title {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 10px;
            color: #ffd700;
        }
        
        .indicator-value {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
            padding: 5px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .value-label {
            color: #ccc;
        }
        
        .value-number {
            font-weight: bold;
        }
        
        .status-positive { color: #4CAF50; }
        .status-negative { color: #f44336; }
        .status-neutral { color: #ff9800; }
        
        #chart {
            height: 500px;
            width: 100%;
        }
        
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            font-size: 1.2em;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="symbol-selector">
                <label for="symbol-select">Simbolo:</label>
                <select id="symbol-select">
                    <option value="">Seleziona simbolo...</option>
                </select>
                <label for="timeframe-select">Timeframe:</label>
                <select id="timeframe-select">
                    <option value="1h">1 Ora</option>
                    <option value="4h" selected>4 Ore</option>
                    <option value="1d">1 Giorno</option>
                </select>
            </div>
            <div class="price-info">
                <div id="current-price" class="current-price">--</div>
                <div id="price-change" class="price-change">--</div>
            </div>
        </div>
        
        <div class="main-content">
            <div class="chart-container">
                <div id="chart"></div>
            </div>
            
            <div class="indicators-panel">
                <div class="indicator-section">
                    <div class="indicator-title">📈 Trend Indicators</div>
                    <div class="indicator-value">
                        <span class="value-label">EMA 20:</span>
                        <span id="ema20" class="value-number">--</span>
                    </div>
                    <div class="indicator-value">
                        <span class="value-label">EMA 50:</span>
                        <span id="ema50" class="value-number">--</span>
                    </div>
                    <div class="indicator-value">
                        <span class="value-label">SMA 200:</span>
                        <span id="sma200" class="value-number">--</span>
                    </div>
                    <div class="indicator-value">
                        <span class="value-label">Trend:</span>
                        <span id="trend-status" class="value-number">--</span>
                    </div>
                </div>
                
                <div class="indicator-section">
                    <div class="indicator-title">⚡ Momentum</div>
                    <div class="indicator-value">
                        <span class="value-label">RSI (14):</span>
                        <span id="rsi" class="value-number">--</span>
                    </div>
                    <div class="indicator-value">
                        <span class="value-label">MACD:</span>
                        <span id="macd" class="value-number">--</span>
                    </div>
                    <div class="indicator-value">
                        <span class="value-label">MACD Signal:</span>
                        <span id="macd-signal" class="value-number">--</span>
                    </div>
                    <div class="indicator-value">
                        <span class="value-label">Stochastic K:</span>
                        <span id="stoch-k" class="value-number">--</span>
                    </div>
                </div>
                
                <div class="indicator-section">
                    <div class="indicator-title">📊 Volatilità</div>
                    <div class="indicator-value">
                        <span class="value-label">Bollinger Upper:</span>
                        <span id="bb-upper" class="value-number">--</span>
                    </div>
                    <div class="indicator-value">
                        <span class="value-label">Bollinger Lower:</span>
                        <span id="bb-lower" class="value-number">--</span>
                    </div>
                    <div class="indicator-value">
                        <span class="value-label">ATR (14):</span>
                        <span id="atr" class="value-number">--</span>
                    </div>
                </div>
                
                <div class="indicator-section">
                    <div class="indicator-title">🎯 Segnali Trading</div>
                    <div class="indicator-value">
                        <span class="value-label">Posizione BB:</span>
                        <span id="bb-position" class="value-number">--</span>
                    </div>
                    <div class="indicator-value">
                        <span class="value-label">MACD Crossover:</span>
                        <span id="macd-cross" class="value-number">--</span>
                    </div>
                    <div class="indicator-value">
                        <span class="value-label">RSI Condition:</span>
                        <span id="rsi-condition" class="value-number">--</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Simboli watchlist
        const watchlistSymbols = [
            'BTCUSDC','ETHUSDC','SOLEUR','FETUSDC','DOTUSDC','LTCUSDC','BNBUSDC','ADAUSDC',
            'FILUSDC','AVAXUSDC','MANAUSDC','SUIUSDC','ALGOUSDT','NEARUSDC','LINKUSDC',
            'UNIUSDC','BELUSDC','SLFUSDC','APEUSDC','DOGEUSDC','ATOMUSDC'
        ];

        // Variabili globali
        let chart, candleSeries, selectedSymbol = watchlistSymbols[0];
        let currentTimeframe = '4h';
        let currentData = [];

        // Inizializzazione
        window.addEventListener('DOMContentLoaded', function() {
            initializeChart();
            populateSymbolSelect();
            setupEventListeners();
            loadInitialData();
        });

        function initializeChart() {
            chart = LightweightCharts.createChart(document.getElementById('chart'), {
                width: 0,
                height: 500,
                layout: {
                    background: { color: 'transparent' },
                    textColor: 'white',
                },
                grid: {
                    vertLines: { color: 'rgba(255, 255, 255, 0.1)' },
                    horzLines: { color: 'rgba(255, 255, 255, 0.1)' },
                },
                crosshair: {
                    mode: LightweightCharts.CrosshairMode.Normal,
                },
                timeScale: {
                    borderColor: 'rgba(255, 255, 255, 0.2)',
                },
                priceScale: {
                    borderColor: 'rgba(255, 255, 255, 0.2)',
                },
            });

            candleSeries = chart.addCandlestickSeries({
                upColor: '#4CAF50',
                downColor: '#f44336',
                borderDownColor: '#f44336',
                borderUpColor: '#4CAF50',
                wickDownColor: '#f44336',
                wickUpColor: '#4CAF50',
            });

            // Ridimensionamento automatico
            window.addEventListener('resize', () => {
                chart.applyOptions({ 
                    width: document.getElementById('chart').clientWidth 
                });
            });
        }

        function populateSymbolSelect() {
            const symbolSelect = document.getElementById('symbol-select');
            watchlistSymbols.forEach(symbol => {
                const option = document.createElement('option');
                option.value = symbol;
                option.textContent = symbol;
                symbolSelect.appendChild(option);
            });
            symbolSelect.value = selectedSymbol;
        }

        function setupEventListeners() {
            document.getElementById('symbol-select').addEventListener('change', function() {
                if (this.value && this.value !== selectedSymbol) {
                    selectedSymbol = this.value;
                    loadMarketData();
                }
            });

            document.getElementById('timeframe-select').addEventListener('change', function() {
                if (this.value !== currentTimeframe) {
                    currentTimeframe = this.value;
                    loadMarketData();
                }
            });
        }

        function loadInitialData() {
            loadMarketData();
            // Aggiorna ogni 30 secondi
            setInterval(() => {
                getCurrentPrice();
            }, 30000);
        }

        function getCurrentPrice() {
            fetch(`https://api.binance.com/api/v3/ticker/24hr?symbol=${selectedSymbol}`)
                .then(response => response.json())
                .then(data => {
                    const price = parseFloat(data.lastPrice);
                    const change = parseFloat(data.priceChangePercent);
                    
                    document.getElementById('current-price').textContent = 
                        `$${price.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 6})}`;
                    
                    const changeEl = document.getElementById('price-change');
                    changeEl.textContent = `${change >= 0 ? '+' : ''}${change.toFixed(2)}%`;
                    changeEl.className = `price-change ${change >= 0 ? 'price-up' : 'price-down'}`;
                })
                .catch(err => console.error('Errore prezzo:', err));
        }

        function loadMarketData() {
            document.getElementById('current-price').textContent = 'Caricamento...';
            
            // Mappa timeframe per Binance API
            const binanceIntervals = {
                '1h': '1h',
                '4h': '4h',
                '1d': '1d'
            };

            fetch(`https://api.binance.com/api/v3/klines?symbol=${selectedSymbol}&interval=${binanceIntervals[currentTimeframe]}&limit=200`)
                .then(response => response.json())
                .then(data => {
                    currentData = data.map(candle => ({
                        time: Math.floor(candle[0] / 1000),
                        open: parseFloat(candle[1]),
                        high: parseFloat(candle[2]),
                        low: parseFloat(candle[3]),
                        close: parseFloat(candle[4]),
                        volume: parseFloat(candle[5])
                    }));

                    candleSeries.setData(currentData);
                    calculateIndicators();
                    getCurrentPrice();
                })
                .catch(err => {
                    console.error('Errore caricamento dati:', err);
                    document.getElementById('current-price').textContent = 'Errore';
                });
        }

        // Funzioni per calcolo indicatori (implementazione Pine Script)
        function calculateSMA(data, period) {
            const sma = [];
            for (let i = period - 1; i < data.length; i++) {
                let sum = 0;
                for (let j = 0; j < period; j++) {
                    sum += data[i - j].close;
                }
                sma.push(sum / period);
            }
            return sma;
        }

        function calculateEMA(data, period) {
            const ema = [];
            const multiplier = 2 / (period + 1);
            
            // Prima EMA è SMA
            let sum = 0;
            for (let i = 0; i < period; i++) {
                sum += data[i].close;
            }
            ema.push(sum / period);
            
            // Calcolo EMA successive
            for (let i = period; i < data.length; i++) {
                const currentEMA = (data[i].close - ema[ema.length - 1]) * multiplier + ema[ema.length - 1];
                ema.push(currentEMA);
            }
            
            return ema;
        }

        function calculateRSI(data, period = 14) {
            const changes = [];
            for (let i = 1; i < data.length; i++) {
                changes.push(data[i].close - data[i - 1].close);
            }
            
            let avgGain = 0, avgLoss = 0;
            
            // Calcolo iniziale
            for (let i = 0; i < period; i++) {
                if (changes[i] > 0) avgGain += changes[i];
                else avgLoss += Math.abs(changes[i]);
            }
            avgGain /= period;
            avgLoss /= period;
            
            const rsi = [];
            
            for (let i = period; i < changes.length; i++) {
                const change = changes[i];
                
                if (change > 0) {
                    avgGain = (avgGain * (period - 1) + change) / period;
                    avgLoss = (avgLoss * (period - 1)) / period;
                } else {
                    avgGain = (avgGain * (period - 1)) / period;
                    avgLoss = (avgLoss * (period - 1) + Math.abs(change)) / period;
                }
                
                const rs = avgGain / avgLoss;
                rsi.push(100 - (100 / (1 + rs)));
            }
            
            return rsi;
        }

        function calculateMACD(data, fast = 12, slow = 26, signal = 9) {
            const emaFast = calculateEMA(data, fast);
            const emaSlow = calculateEMA(data, slow);
            
            const macd = [];
            const minLength = Math.min(emaFast.length, emaSlow.length);
            
            for (let i = 0; i < minLength; i++) {
                macd.push(emaFast[i] - emaSlow[i]);
            }
            
            // Calcolo signal line (EMA del MACD)
            const macdData = macd.map(value => ({ close: value }));
            const signalLine = calculateEMA(macdData, signal);
            
            return { macd, signal: signalLine };
        }

        function calculateBollingerBands(data, period = 20, deviation = 2) {
            const sma = calculateSMA(data, period);
            const bands = { upper: [], lower: [], middle: sma };
            
            for (let i = period - 1; i < data.length; i++) {
                let sum = 0;
                const avg = sma[i - period + 1];
                
                for (let j = 0; j < period; j++) {
                    const diff = data[i - j].close - avg;
                    sum += diff * diff;
                }
                
                const stdDev = Math.sqrt(sum / period);
                bands.upper.push(avg + (stdDev * deviation));
                bands.lower.push(avg - (stdDev * deviation));
            }
            
            return bands;
        }

        function calculateATR(data, period = 14) {
            const trueRanges = [];
            
            for (let i = 1; i < data.length; i++) {
                const current = data[i];
                const previous = data[i - 1];
                
                const tr1 = current.high - current.low;
                const tr2 = Math.abs(current.high - previous.close);
                const tr3 = Math.abs(current.low - previous.close);
                
                trueRanges.push(Math.max(tr1, tr2, tr3));
            }
            
            // Calcolo ATR come media mobile
            const atr = [];
            for (let i = period - 1; i < trueRanges.length; i++) {
                let sum = 0;
                for (let j = 0; j < period; j++) {
                    sum += trueRanges[i - j];
                }
                atr.push(sum / period);
            }
            
            return atr;
        }

        function calculateStochastic(data, kPeriod = 14, dPeriod = 3) {
            const k = [];
            
            for (let i = kPeriod - 1; i < data.length; i++) {
                let highest = data[i].high;
                let lowest = data[i].low;
                
                for (let j = 0; j < kPeriod; j++) {
                    const candle = data[i - j];
                    highest = Math.max(highest, candle.high);
                    lowest = Math.min(lowest, candle.low);
                }
                
                const kValue = ((data[i].close - lowest) / (highest - lowest)) * 100;
                k.push(kValue);
            }
            
            return k;
        }

        function calculateIndicators() {
            if (currentData.length < 50) return;
            
            try {
                // Calcolo indicatori
                const ema20 = calculateEMA(currentData, 20);
                const ema50 = calculateEMA(currentData, 50);
                const sma200 = calculateSMA(currentData, 200);
                const rsi = calculateRSI(currentData, 14);
                const macdData = calculateMACD(currentData);
                const bb = calculateBollingerBands(currentData, 20, 2);
                const atr = calculateATR(currentData, 14);
                const stoch = calculateStochastic(currentData, 14);
                
                // Ottieni valori più recenti
                const currentPrice = currentData[currentData.length - 1].close;
                const latestEMA20 = ema20[ema20.length - 1];
                const latestEMA50 = ema50[ema50.length - 1];
                const latestSMA200 = sma200[sma200.length - 1];
                const latestRSI = rsi[rsi.length - 1];
                const latestMACD = macdData.macd[macdData.macd.length - 1];
                const latestSignal = macdData.signal[macdData.signal.length - 1];
                const latestBBUpper = bb.upper[bb.upper.length - 1];
                const latestBBLower = bb.lower[bb.lower.length - 1];
                const latestATR = atr[atr.length - 1];
                const latestStoch = stoch[stoch.length - 1];
                
                // Aggiorna UI
                updateIndicatorValue('ema20', latestEMA20);
                updateIndicatorValue('ema50', latestEMA50);
                updateIndicatorValue('sma200', latestSMA200);
                updateIndicatorValue('rsi', latestRSI, getRSIStatus(latestRSI));
                updateIndicatorValue('macd', latestMACD);
                updateIndicatorValue('macd-signal', latestSignal);
                updateIndicatorValue('bb-upper', latestBBUpper);
                updateIndicatorValue('bb-lower', latestBBLower);
                updateIndicatorValue('atr', latestATR);
                updateIndicatorValue('stoch-k', latestStoch);
                
                // Calcolo segnali
                const trendStatus = getTrendStatus(currentPrice, latestEMA20, latestEMA50, latestSMA200);
                const bbPosition = getBBPosition(currentPrice, latestBBUpper, latestBBLower);
                const macdCross = getMACD_Cross(latestMACD, latestSignal);
                const rsiCondition = getRSICondition(latestRSI);
                
                updateIndicatorStatus('trend-status', trendStatus);
                updateIndicatorStatus('bb-position', bbPosition);
                updateIndicatorStatus('macd-cross', macdCross);
                updateIndicatorStatus('rsi-condition', rsiCondition);
                
            } catch (error) {
                console.error('Errore calcolo indicatori:', error);
            }
        }

        function updateIndicatorValue(id, value, status = null) {
            const element = document.getElementById(id);
            if (element && !isNaN(value)) {
                element.textContent = value.toFixed(4);
                if (status) {
                    element.className = `value-number ${status}`;
                }
            }
        }

        function updateIndicatorStatus(id, status) {
            const element = document.getElementById(id);
            if (element) {
                element.textContent = status.text;
                element.className = `value-number ${status.class}`;
            }
        }

        function getTrendStatus(price, ema20, ema50, sma200) {
            if (price > ema20 && ema20 > ema50 && ema50 > sma200) {
                return { text: '🟢 Rialzista Forte', class: 'status-positive' };
            } else if (price > ema20 && ema20 > ema50) {
                return { text: '🟡 Rialzista', class: 'status-neutral' };
            } else if (price < ema20 && ema20 < ema50 && ema50 < sma200) {
                return { text: '🔴 Ribassista Forte', class: 'status-negative' };
            } else if (price < ema20 && ema20 < ema50) {
                return { text: '🟠 Ribassista', class: 'status-negative' };
            } else {
                return { text: '➡️ Laterale', class: 'status-neutral' };
            }
        }

        function getRSIStatus(rsi) {
            if (rsi > 70) return 'status-negative';
            if (rsi < 30) return 'status-positive';
            return 'status-neutral';
        }

        function getRSICondition(rsi) {
            if (rsi > 70) return { text: '⚠️ Ipercomprato', class: 'status-negative' };
            if (rsi < 30) return { text: '✅ Ipervenduto', class: 'status-positive' };
            return { text: '➡️ Neutrale', class: 'status-neutral' };
        }

        function getBBPosition(price, upper, lower) {
            const position = (price - lower) / (upper - lower);
            if (position > 0.8) return { text: '⚠️ Vicino Resistenza', class: 'status-negative' };
            if (position < 0.2) return { text: '✅ Vicino Supporto', class: 'status-positive' };
            return { text: '➡️ Centro Banda', class: 'status-neutral' };
        }

        function getMACD_Cross(macd, signal) {
            if (macd > signal) return { text: '🟢 Sopra Signal', class: 'status-positive' };
            if (macd < signal) return { text: '🔴 Sotto Signal', class: 'status-negative' };
            return { text: '➡️ Neutrale', class: 'status-neutral' };
        }
    </script>
</body>
</html>